<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ThreadLocalæºç è§£æ | å¿ƒæ— è¿·æƒ˜</title>
  <meta name="keywords" content=" jdk ">
  <meta name="description" content="ThreadLocalæºç è§£æ | å¿ƒæ— è¿·æƒ˜">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="11æœˆçš„æœ€åä¸€å¤©ï¼Œå³æ—¶ç»“æŸåˆæ˜¯å¼€å§‹ã€‚å¸Œæœ›æˆ‘ä»¬éƒ½èƒ½å¤ŸåŠªåŠ›å­¦ä¹ ï¼ŒåšæŒä¸æ‡ˆçš„å»è¿½é€è‡ªå·±çš„æ¢¦æƒ³ã€‚å¤ä¹‹ç«‹å¤§äº‹è€…ï¼Œä¸æƒŸæœ‰è¶…ä¸–ä¹‹æ‰ï¼Œäº¦å¿…æœ‰åšå¿ä¸æ‹”ä¹‹å¿— å¿ƒå­˜è¿·æƒ˜ åˆ™æ— æ³•ç»§ç»­å‰è¡ŒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ª">
<meta property="og:type" content="website">
<meta property="og:title" content="å…³äº">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;about&#x2F;index.html">
<meta property="og:site_name" content="å¿ƒæ— è¿·æƒ˜">
<meta property="og:description" content="11æœˆçš„æœ€åä¸€å¤©ï¼Œå³æ—¶ç»“æŸåˆæ˜¯å¼€å§‹ã€‚å¸Œæœ›æˆ‘ä»¬éƒ½èƒ½å¤ŸåŠªåŠ›å­¦ä¹ ï¼ŒåšæŒä¸æ‡ˆçš„å»è¿½é€è‡ªå·±çš„æ¢¦æƒ³ã€‚å¤ä¹‹ç«‹å¤§äº‹è€…ï¼Œä¸æƒŸæœ‰è¶…ä¸–ä¹‹æ‰ï¼Œäº¦å¿…æœ‰åšå¿ä¸æ‹”ä¹‹å¿— å¿ƒå­˜è¿·æƒ˜ åˆ™æ— æ³•ç»§ç»­å‰è¡ŒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ§ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ª">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-15T13:29:23.087Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Ocean Bai</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/oceanbai" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active">å…¨éƒ¨æ–‡ç« <small>(30)</small></div></li>
    
        
            
            <li><div data-rel="javaåŸºç¡€">javaåŸºç¡€<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="ç®—æ³•">ç®—æ³•<small>(4)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="è®¾è®¡åŸåˆ™">è®¾è®¡åŸåˆ™<small>(7)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="é¢è¯•">é¢è¯•<small>(4)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="dubbo">dubbo<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="JDK">JDK<small>(2)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">å…³äº</a><a style="width: 50%"  class="friends">å‹é“¾</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="30">
<input type="hidden" id="yelog_site_word_count" value="110.7k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        å‹æƒ…é“¾æ¥
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://yelog.org/">å¶è½é˜</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="Search..." autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color3">åƒåœ¾</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">ç®—æ³•</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">ç±»åŠ è½½å™¨</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">ç¼“å­˜</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">è®¾è®¡åŸåˆ™</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">åå°„</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">è®¾è®¡æ¨¡å¼</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">å·¥å‚æ¨¡å¼</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">é¢è¯•</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">æ€»ç»“é¢è¯•</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">åŠ¨æ€ä»£ç†</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">SPI</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">jdk</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">çº¿ç¨‹æ± </a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class="JDK "
           href="/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"
           data-tag="jdk"
           data-author="" >
            <span class="post-title" title="ThreadLocalæºç è§£æ">ThreadLocalæºç è§£æ</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="é¢è¯• "
           href="/2020/02/18/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E6%8A%80%E6%9C%AF%E6%A0%88/"
           data-tag="é¢è¯•,æ€»ç»“é¢è¯•"
           data-author="" >
            <span class="post-title" title="é¢è¯•æŠ€æœ¯æ ˆ">é¢è¯•æŠ€æœ¯æ ˆ</span>
            <span class="post-date" title="2020-02-18 16:41:32">2020/02/18</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/17/dubbo/dubboSPI/"
           data-tag="SPI"
           data-author="" >
            <span class="post-title" title="dubboSPIè¯¦è§£">dubboSPIè¯¦è§£</span>
            <span class="post-date" title="2020-02-17 14:41:31">2020/02/17</span>
        </a>
        
        <a  class="é¢è¯• "
           href="/2020/02/17/%E9%9D%A2%E8%AF%95/%E7%BE%8E%E5%9B%A2%E7%A0%94%E7%A9%B6%E7%94%9F%E5%AE%9E%E4%B9%A0%E7%94%9F/"
           data-tag="é¢è¯•"
           data-author="" >
            <span class="post-title" title="ç¾å›¢ç ”ç©¶ç”Ÿå®ä¹ ç”Ÿ">ç¾å›¢ç ”ç©¶ç”Ÿå®ä¹ ç”Ÿ</span>
            <span class="post-date" title="2020-02-17 11:41:31">2020/02/17</span>
        </a>
        
        <a  class=""
           href="/2020/02/17/%E7%AE%97%E6%B3%95/%E5%9F%BA%E6%9C%AC%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="ç®—æ³•/åŸºæœ¬æ’åºç®—æ³•">ç®—æ³•/åŸºæœ¬æ’åºç®—æ³•</span>
            <span class="post-date" title="2020-02-17 10:46:52">2020/02/17</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/15/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="æ¡¥æ¥æ¨¡å¼----å¤„ç†å¤šç»´å˜åŒ–----äº”">æ¡¥æ¥æ¨¡å¼----å¤„ç†å¤šç»´å˜åŒ–----äº”</span>
            <span class="post-date" title="2020-02-15 21:42:31">2020/02/15</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/15/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="é€‚é…å™¨æ¨¡å¼----ä¸å…¼å®¹ç»“æ„çš„åè°ƒ----å…­">é€‚é…å™¨æ¨¡å¼----ä¸å…¼å®¹ç»“æ„çš„åè°ƒ----å…­</span>
            <span class="post-date" title="2020-02-15 21:42:31">2020/02/15</span>
        </a>
        
        <a  class="é¢è¯• "
           href="/2020/02/15/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E9%A2%98/"
           data-tag="é¢è¯•"
           data-author="" >
            <span class="post-title" title="é¢è¯•é¢˜">é¢è¯•é¢˜</span>
            <span class="post-date" title="2020-02-15 21:41:32">2020/02/15</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/14/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼--------å››">æ¨¡æ¿æ–¹æ³•æ¨¡å¼--------å››</span>
            <span class="post-date" title="2020-02-14 16:38:31">2020/02/14</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/13/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼,å·¥å‚æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="æŠ½è±¡å·¥å‚æ¨¡å¼--------ä¸‰">æŠ½è±¡å·¥å‚æ¨¡å¼--------ä¸‰</span>
            <span class="post-date" title="2020-02-13 21:41:31">2020/02/13</span>
        </a>
        
        <a  class="javaåŸºç¡€ "
           href="/2020/02/12/java/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8(ClassLoader)/"
           data-tag="ç±»åŠ è½½å™¨"
           data-author="" >
            <span class="post-title" title="æ·±å…¥ç†è§£javaç±»åŠ è½½å™¨(ClassLoader)">æ·±å…¥ç†è§£javaç±»åŠ è½½å™¨(ClassLoader)</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="javaåŸºç¡€ "
           href="/2020/02/12/java/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF(Class%E5%AF%B9%E8%B1%A1)%E4%B8%8E%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"
           data-tag="åå°„"
           data-author="" >
            <span class="post-title" title="æ·±å…¥ç†è§£Javaç±»å‹ä¿¡æ¯(Classå¯¹è±¡)ä¸åå°„æœºåˆ¶">æ·±å…¥ç†è§£Javaç±»å‹ä¿¡æ¯(Classå¯¹è±¡)ä¸åå°„æœºåˆ¶</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="ç®—æ³• "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E5%9B%9E%E6%96%87%E6%95%B0/"
           data-tag="ç®—æ³•"
           data-author="" >
            <span class="post-title" title="å›æ–‡æ•°">å›æ–‡æ•°</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="ç®—æ³• "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95%E9%A2%9803-%E6%95%B0%E7%BB%84%E4%B8%AD%E9%87%8D%E5%A4%8D%E7%9A%84%E6%95%B0%E5%AD%97/"
           data-tag="ç®—æ³•"
           data-author="" >
            <span class="post-title" title="é¢è¯•é¢˜03-æ•°ç»„ä¸­é‡å¤çš„æ•°å­—">é¢è¯•é¢˜03-æ•°ç»„ä¸­é‡å¤çš„æ•°å­—</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="ç®—æ³• "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E7%BC%93%E5%AD%98%E7%AE%97%E6%B3%95------FIFO%20%E3%80%81LRU%E3%80%81LFU/"
           data-tag="ç¼“å­˜"
           data-author="" >
            <span class="post-title" title="ç¼“å­˜ç®—æ³•ï¼ˆFIFOã€LRUã€LFUï¼‰">ç¼“å­˜ç®—æ³•ï¼ˆFIFOã€LRUã€LFUï¼‰</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼,å·¥å‚æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="å·¥å‚æ–¹æ³•æ¨¡å¼--------äºŒ">å·¥å‚æ–¹æ³•æ¨¡å¼--------äºŒ</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="javaåŸºç¡€ "
           href="/2020/02/11/java/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"
           data-tag="åƒåœ¾"
           data-author="" >
            <span class="post-title" title="åƒåœ¾å›æ”¶">åƒåœ¾å›æ”¶</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="è®¾è®¡æ¨¡å¼ "
           href="/2020/02/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"
           data-tag="è®¾è®¡æ¨¡å¼,å·¥å‚æ¨¡å¼"
           data-author="" >
            <span class="post-title" title="ç®€å•å·¥å‚æ¨¡å¼--------ä¸€">ç®€å•å·¥å‚æ¨¡å¼--------ä¸€</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/11/dubbo/dubbo%E9%9D%A2%E8%AF%95%E9%A2%98/"
           data-tag="é¢è¯•"
           data-author="" >
            <span class="post-title" title="dubboé¢è¯•é¢˜">dubboé¢è¯•é¢˜</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/11/dubbo/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20RPC%20%E4%B9%8B%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%AF%87/"
           data-tag="åŠ¨æ€ä»£ç†"
           data-author="" >
            <span class="post-title" title="æ·±å…¥ç†è§£ RPC ä¹‹åŠ¨æ€ä»£ç†ç¯‡">æ·±å…¥ç†è§£ RPC ä¹‹åŠ¨æ€ä»£ç†ç¯‡</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="JDK "
           href="/2020/02/11/java/JDK/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%A7%A3%E6%9E%90/"
           data-tag="çº¿ç¨‹æ± "
           data-author="" >
            <span class="post-title" title="çº¿ç¨‹æ± æºç è§£æ">çº¿ç¨‹æ± æºç è§£æ</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="ç®—æ³• "
           href="/2019/11/30/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%8F%89%E5%A0%86/"
           data-tag="ç®—æ³•"
           data-author="" >
            <span class="post-title" title="äºŒå‰å †">äºŒå‰å †</span>
            <span class="post-date" title="2019-11-30 21:49:13">2019/11/30</span>
        </a>
        
        <a  class="é¢è¯• "
           href="/2019/11/30/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E8%A6%81%E6%B1%82/"
           data-tag="é¢è¯•"
           data-author="" >
            <span class="post-title" title="åˆ«äººé¢è¯•è¦æ±‚">åˆ«äººé¢è¯•è¦æ±‚</span>
            <span class="post-date" title="2019-11-30 21:41:31">2019/11/30</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬ä¸‰åŸåˆ™:å•ä¸€èŒè´£åŸåˆ™">ç¬¬ä¸‰åŸåˆ™:å•ä¸€èŒè´£åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬äºŒåŸåˆ™:ä¾èµ–å€’ç½®åŸåˆ™">ç¬¬äºŒåŸåˆ™:ä¾èµ–å€’ç½®åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%90%88%E6%88%90%E5%A4%8D%E7%94%A8%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬ä¸ƒåŸåˆ™:åˆæˆå¤ç”¨åŸåˆ™">ç¬¬ä¸ƒåŸåˆ™:åˆæˆå¤ç”¨åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬ä¸€åŸåˆ™:å¼€é—­åŸåˆ™">ç¬¬ä¸€åŸåˆ™:å¼€é—­åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬å››åŸåˆ™:æ¥å£éš”ç¦»åŸåˆ™">ç¬¬å››åŸåˆ™:æ¥å£éš”ç¦»åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬å…­åŸåˆ™:é‡Œæ°æ›¿æ¢åŸåˆ™">ç¬¬å…­åŸåˆ™:é‡Œæ°æ›¿æ¢åŸåˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="è®¾è®¡åŸåˆ™ "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99/"
           data-tag="è®¾è®¡åŸåˆ™"
           data-author="" >
            <span class="post-title" title="ç¬¬äº”åŸåˆ™:è¿ªç±³ç‰¹æ³•åˆ™">ç¬¬äº”åŸåˆ™:è¿ªç±³ç‰¹æ³•åˆ™</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-java/JDK/ThreadLocalæºç è§£æ" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">ThreadLocalæºç è§£æ</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a  data-rel="JDK">JDK</a>
            
        </span>
        
        
        <span class="tag">
            
            <a class="color4">jdk</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        åˆ›å»ºæ—¶é—´:<time class="date" title='æ›´æ–°æ—¶é—´: 2020-02-19 10:18:17'>2020-02-19 09:41</time>
        
    </div>
    <div class="article-meta">
        
        <span>å­—æ•°:5.1k</span>
        
        
        <span id="busuanzi_container_page_pv">
            é˜…è¯»:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨"><span class="toc-text">ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#å‰æ"><span class="toc-text">å‰æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocalæ˜¯ä»€ä¹ˆ"><span class="toc-text">ThreadLocalæ˜¯ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocalçš„åŸç†"><span class="toc-text">ThreadLocalçš„åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocalæºç åˆ†æ"><span class="toc-text">ThreadLocalæºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalçš„å†…éƒ¨å±æ€§"><span class="toc-text">ThreadLocalçš„å†…éƒ¨å±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ"><span class="toc-text">å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocalçš„åˆ›å»º"><span class="toc-text">ThreadLocalçš„åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocalçš„setæ–¹æ³•"><span class="toc-text">TreadLocalçš„setæ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocalçš„getæ–¹æ³•"><span class="toc-text">TreadLocalçš„getæ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocalçš„removeæ–¹æ³•"><span class="toc-text">TreadLocalçš„removeæ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal-ThreadLocalMapçš„åˆå§‹åŒ–"><span class="toc-text">ThreadLocal.ThreadLocalMapçš„åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼"><span class="toc-text">ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocalçš„æœ€ä½³å®è·µ"><span class="toc-text">ThreadLocalçš„æœ€ä½³å®è·µ</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨"><a href="#ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨" class="headerlink" title="ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨"></a>ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨</h1><h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>æœ€è¿‘æ¥è§¦åˆ°çš„ä¸€ä¸ªé¡¹ç›®è¦å…¼å®¹æ–°è€ç³»ç»Ÿï¼Œæœ€ç»ˆé‡‡ç”¨äº†<code>ThreadLocal</code>(å®é™…ä¸Šç”¨çš„æ˜¯<code>InheritableThreadLocal</code>)ç”¨äºåœ¨å­çº¿ç¨‹è·å–çˆ¶çº¿ç¨‹ä¸­å…±äº«çš„å˜é‡ã€‚é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯åæ¥å‘ç°å¯¹<code>ThreadLocal</code>çš„ç†è§£ä¸å¤Ÿæ·±å…¥ï¼Œäºæ˜¯é¡ºä¾¿æŠŠå®ƒçš„æºç é˜…è¯»ç†è§£äº†ä¸€éã€‚åœ¨è°ˆåˆ°<code>ThreadLocal</code>ä¹‹å‰å…ˆå–ä¸ªå…³å­ï¼Œå…ˆè°ˆè°ˆé»„é‡‘åˆ†å‰²æ•°ã€‚æœ¬æ–‡åœ¨é˜…è¯»<code>ThreadLocal</code>æºç çš„æ—¶å€™æ˜¯ä½¿ç”¨JDK8(1.8.0_181)ã€‚</p>
<h2 id="ThreadLocalæ˜¯ä»€ä¹ˆ"><a href="#ThreadLocalæ˜¯ä»€ä¹ˆ" class="headerlink" title="ThreadLocalæ˜¯ä»€ä¹ˆ"></a>ThreadLocalæ˜¯ä»€ä¹ˆ</h2><p>ä¸‹é¢å¼•ç”¨<code>ThreadLocal</code>çš„APIæ³¨é‡Šï¼š</p>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)</p>
</blockquote>
<p>ç¨å¾®ç¿»è¯‘ä¸€ä¸‹ï¼š<code>ThreadLocal</code>æä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®<code>ThreadLocal</code>å®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚<code>ThreadLocal</code>å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚</p>
<p><code>ThreadLocal</code>ç”±Javaç•Œçš„ä¸¤ä¸ªå¤§å¸ˆçº§çš„ä½œè€…ç¼–å†™ï¼ŒJosh Blochå’ŒDoug Leaã€‚Josh Blochæ˜¯JDK5è¯­è¨€å¢å¼ºã€Javaé›†åˆ(Collection)æ¡†æ¶çš„åˆ›åŠäººä»¥åŠã€ŠEffective Javaã€‹ç³»åˆ—çš„ä½œè€…ã€‚Doug Leaæ˜¯JUC(<code>java.util.concurrent</code>)åŒ…çš„ä½œè€…ï¼ŒJavaå¹¶å‘ç¼–ç¨‹çš„æ³°æ–—ã€‚æ‰€ä»¥ï¼Œ<code>ThreadLocal</code>çš„æºç ååˆ†å€¼å¾—å­¦ä¹ ã€‚</p>
<h2 id="ThreadLocalçš„åŸç†"><a href="#ThreadLocalçš„åŸç†" class="headerlink" title="ThreadLocalçš„åŸç†"></a>ThreadLocalçš„åŸç†</h2><p><code>ThreadLocal</code>è™½ç„¶å«çº¿ç¨‹æœ¬åœ°(å±€éƒ¨)å˜é‡ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒå¹¶ä¸å­˜æ”¾ä»»ä½•çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼š<strong>å®ƒæ˜¯çº¿ç¨‹(<code>Thread</code>)æ“ä½œ<code>ThreadLocalMap</code>ä¸­å­˜æ”¾çš„å˜é‡çš„æ¡¥æ¢</strong>ã€‚å®ƒä¸»è¦æä¾›äº†åˆå§‹åŒ–ã€<code>set()</code>ã€<code>get()</code>ã€<code>remove()</code>å‡ ä¸ªæ–¹æ³•ã€‚è¿™æ ·è¯´å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹é¢ç”»ä¸ªå›¾è¯´æ˜ä¸€ä¸‹åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨<code>ThreadLocal</code>å®ä¾‹çš„<code>set()</code>å’Œ<code>get()</code>æ–¹æ³•çš„ç®€å•æµç¨‹å›¾ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ä»£ç ï¼Œä¸»çº¿ç¨‹çš„çº¿ç¨‹åå­—æ˜¯main(ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯main)ï¼š</p>
<pre><code class="java">public class Main {

    private static final ThreadLocal&lt;String&gt; LOCAL = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception{
        LOCAL.set(&quot;doge&quot;);
        System.out.println(LOCAL.get());
    }
}</code></pre>
<p>çº¿ç¨‹å®ä¾‹å’Œ<code>ThreadLocal</code>å®ä¾‹çš„å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="/imag/Factory/image-20200219100146621.png" alt="image-20200219100146621"></p>
<p>ä¸Šé¢åªæè¿°äº†å•çº¿ç¨‹çš„æƒ…å†µå¹¶ä¸”å› ä¸ºæ˜¯ä¸»çº¿ç¨‹å¿½ç•¥äº†<code>Thread t = new Thread()</code>è¿™ä¸€æ­¥ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯åŸç†æ˜¯ä¸å˜çš„ï¼Œ<code>ThreadLocal</code>å®ä¾‹æ€»æ˜¯é€šè¿‡<code>Thread.currentThread()</code><strong>è·å–åˆ°å½“å‰æ“ä½œçº¿ç¨‹å®ä¾‹</strong>ï¼Œç„¶åå»æ“ä½œçº¿ç¨‹å®ä¾‹ä¸­çš„<code>ThreadLocalMap</code>ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå› æ­¤å®ƒæ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼Œæœ¬èº«ä¸å…·å¤‡å­˜å‚¨åŠŸèƒ½ã€‚</p>
<h2 id="ThreadLocalæºç åˆ†æ"><a href="#ThreadLocalæºç åˆ†æ" class="headerlink" title="ThreadLocalæºç åˆ†æ"></a>ThreadLocalæºç åˆ†æ</h2><p>å¯¹äº<code>ThreadLocal</code>çš„æºç ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨<code>set()</code>ã€<code>get()</code>ã€<code>remove()</code>å‡ ä¸ªæ–¹æ³•ã€‚</p>
<h3 id="ThreadLocalçš„å†…éƒ¨å±æ€§"><a href="#ThreadLocalçš„å†…éƒ¨å±æ€§" class="headerlink" title="ThreadLocalçš„å†…éƒ¨å±æ€§"></a>ThreadLocalçš„å†…éƒ¨å±æ€§</h3><pre><code class="java">//è·å–ä¸‹ä¸€ä¸ªThreadLocalå®ä¾‹çš„å“ˆå¸Œé­”æ•°
private final int threadLocalHashCode = nextHashCode();

//åŸå­è®¡æ•°å™¨ï¼Œä¸»è¦åˆ°å®ƒè¢«å®šä¹‰ä¸ºé™æ€
private static AtomicInteger nextHashCode = new AtomicInteger();

//å“ˆå¸Œé­”æ•°(å¢é•¿æ•°)ï¼Œä¹Ÿæ˜¯å¸¦ç¬¦å·çš„32ä½æ•´å‹å€¼é»„é‡‘åˆ†å‰²å€¼çš„å–æ­£
private static final int HASH_INCREMENT = 0x61c88647;

//ç”Ÿæˆä¸‹ä¸€ä¸ªå“ˆå¸Œé­”æ•°
private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒthreadLocalHashCodeæ˜¯ä¸€ä¸ªfinalçš„å±æ€§ï¼Œè€ŒåŸå­è®¡æ•°å™¨å˜é‡nextHashCodeå’Œç”Ÿæˆä¸‹ä¸€ä¸ªå“ˆå¸Œé­”æ•°çš„æ–¹æ³•<code>nextHashCode()</code>æ˜¯é™æ€å˜é‡å’Œé™æ€æ–¹æ³•ï¼Œé™æ€å˜é‡åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ã€‚æ¢è€Œè¨€ä¹‹ï¼Œæ¯æ–°å»ºä¸€ä¸ª<code>ThreadLocal</code>å®ä¾‹ï¼Œå®ƒå†…éƒ¨çš„threadLocalHashCodeå°±ä¼šå¢åŠ 0x61c88647ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre><code class="java">//t1ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647
ThreadLocal t1 = new ThreadLocal();
//t2ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647 + 0x61c88647
ThreadLocal t2 = new ThreadLocal();
//t3ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647 + 0x61c88647 + 0x61c88647
ThreadLocal t3 = new ThreadLocal();</code></pre>
<p>threadLocalHashCodeæ˜¯ä¸‹é¢çš„<code>ThreadLocalMap</code>ç»“æ„ä¸­ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•çš„æ ¸å¿ƒå˜é‡ï¼Œå¯¹äºæ¯ä¸ª<code>ThreadLocal</code>å®ä¾‹ï¼Œå®ƒçš„threadLocalHashCodeæ˜¯å”¯ä¸€çš„ã€‚</p>
<h3 id="å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ"><a href="#å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ" class="headerlink" title="å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ"></a>å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ</h3><p><code>ThreadLocal</code>å†…éƒ¨ç±»<code>ThreadLocalMap</code>ä½¿ç”¨äº†é»˜è®¤ä¿®é¥°ç¬¦ï¼Œä¹Ÿå°±æ˜¯åŒ…(åŒ…ç§æœ‰)å¯è®¿é—®çš„ã€‚<code>ThreadLocalMap</code>å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªé™æ€ç±»<code>Entry</code>ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹<code>ThreadLocalMap</code>çš„æºç ï¼Œå…ˆçœ‹æˆå‘˜å’Œç»“æ„éƒ¨åˆ†ï¼š</p>
<pre><code class="java">/**
 * ThreadLocalMapæ˜¯ä¸€ä¸ªå®šåˆ¶çš„æ•£åˆ—æ˜ å°„ï¼Œä»…é€‚ç”¨äºç»´æŠ¤çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚
 * å®ƒçš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å®šä¹‰åœ¨ThreadLocalç±»ä¹‹å†…ã€‚
 * å®ƒæ˜¯åŒ…ç§æœ‰çš„ï¼Œæ‰€ä»¥åœ¨Threadç±»ä¸­å¯ä»¥å®šä¹‰ThreadLocalMapä½œä¸ºå˜é‡ã€‚
 * ä¸ºäº†å¤„ç†éå¸¸å¤§(æŒ‡çš„æ˜¯å€¼)å’Œé•¿æ—¶é—´çš„ç”¨é€”ï¼Œå“ˆå¸Œè¡¨çš„Keyä½¿ç”¨äº†å¼±å¼•ç”¨(WeakReferences)ã€‚
 * å¼•ç”¨çš„é˜Ÿåˆ—(å¼±å¼•ç”¨)ä¸å†è¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯¹åº”çš„è¿‡æœŸçš„æ¡ç›®å°±èƒ½é€šè¿‡ä¸»åŠ¨åˆ é™¤ç§»å‡ºå“ˆå¸Œè¡¨ã€‚
 */
static class ThreadLocalMap {

        //æ³¨æ„è¿™é‡Œçš„Entryçš„Keyä¸ºWeakReference&lt;ThreadLocal&lt;?&gt;&gt;
    static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {

        //è¿™ä¸ªæ˜¯çœŸæ­£çš„å­˜æ”¾çš„å€¼
        Object value;
                // Entryçš„Keyå°±æ˜¯ThreadLocalå®ä¾‹æœ¬èº«ï¼ŒValueå°±æ˜¯è¾“å…¥çš„å€¼
        Entry(ThreadLocal&lt;?&gt; k, Object v) {
                    super(k);
                    value = v;
                }
    }
        //åˆå§‹åŒ–å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„å¹‚æ¬¡æ–¹
    private static final int INITIAL_CAPACITY = 16;

        //å“ˆå¸Œ(Entry)è¡¨ï¼Œå¿…é¡»æ—¶æ‰©å®¹ï¼Œé•¿åº¦å¿…é¡»ä¸º2çš„å¹‚æ¬¡æ–¹
    private Entry[] table;

        //å“ˆå¸Œè¡¨ä¸­å…ƒç´ (Entry)çš„ä¸ªæ•°
    private int size = 0;

        //ä¸‹ä¸€æ¬¡éœ€è¦æ‰©å®¹çš„é˜ˆå€¼ï¼Œé»˜è®¤å€¼ä¸º0
    private int threshold;

        //è®¾ç½®ä¸‹ä¸€æ¬¡éœ€è¦æ‰©å®¹çš„é˜ˆå€¼ï¼Œè®¾ç½®å€¼ä¸ºè¾“å…¥å€¼lençš„ä¸‰åˆ†ä¹‹äºŒ
    private void setThreshold(int len) {
        threshold = len * 2 / 3;
    }

    // ä»¥lenä¸ºæ¨¡å¢åŠ i
    private static int nextIndex(int i, int len) {
        return ((i + 1 &lt; len) ? i + 1 : 0);
    }

    // ä»¥lenä¸ºæ¨¡å‡å°‘i
    private static int prevIndex(int i, int len) {
        return ((i - 1 &gt;= 0) ? i - 1 : len - 1);
    }
}</code></pre>
<p>è¿™é‡Œæ³¨æ„åˆ°ååˆ†é‡è¦çš„ä¸€ç‚¹ï¼š<strong><code>ThreadLocalMap$Entry</code>æ˜¯<code>WeakReference</code>(å¼±å¼•ç”¨)ï¼Œå¹¶ä¸”é”®å€¼Keyä¸º<code>ThreadLocal</code>å®ä¾‹æœ¬èº«ï¼Œè¿™é‡Œä½¿ç”¨äº†æ— é™å®šçš„æ³›å‹é€šé…ç¬¦</strong>ã€‚</p>
<p>æ¥ç€çœ‹<code>ThreadLocalMap</code>çš„æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="java">// æ„é€ ThreadLocalæ—¶å€™ä½¿ç”¨ï¼Œå¯¹åº”ThreadLocalçš„å®ä¾‹æ–¹æ³•void createMap(Thread t, T firstValue)
ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
    // å“ˆå¸Œè¡¨é»˜è®¤å®¹é‡ä¸º16
    table = new Entry[INITIAL_CAPACITY];
    // è®¡ç®—ç¬¬ä¸€ä¸ªå…ƒç´ çš„å“ˆå¸Œç 
    int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);
    table[i] = new Entry(firstKey, firstValue);
    size = 1;
    setThreshold(INITIAL_CAPACITY);
}

// æ„é€ InheritableThreadLocalæ—¶å€™ä½¿ç”¨ï¼ŒåŸºäºçˆ¶çº¿ç¨‹çš„ThreadLocalMapé‡Œé¢çš„å†…å®¹è¿›è¡Œæå–æ”¾å…¥æ–°çš„ThreadLocalMapçš„å“ˆå¸Œè¡¨ä¸­
// å¯¹åº”ThreadLocalçš„é™æ€æ–¹æ³•static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap)
private ThreadLocalMap(ThreadLocalMap parentMap) {
    Entry[] parentTable = parentMap.table;
    int len = parentTable.length;
    setThreshold(len);
    table = new Entry[len];
    // åŸºäºçˆ¶ThreadLocalMapçš„å“ˆå¸Œè¡¨è¿›è¡Œæ‹·è´
    for (Entry e : parentTable) {
        if (e != null) {
            @SuppressWarnings(&quot;unchecked&quot;)
            ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get();
            if (key != null) {
                Object value = key.childValue(e.value);
                Entry c = new Entry(key, value);
                int h = key.threadLocalHashCode &amp; (len - 1);
                while (table[h] != null)
                    h = nextIndex(h, len);
                table[h] = c;
                size++;
            }
        }
    }
}</code></pre>
<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œ<code>ThreadLocal</code>çš„<code>set()</code>æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ä¼šæ‡’åˆå§‹åŒ–ä¸€ä¸ª<code>ThreadLocalMap</code>å¹¶ä¸”æ”¾å…¥ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚è€Œ<code>ThreadLocalMap</code>çš„ç§æœ‰æ„é€ æ˜¯æä¾›ç»™é™æ€æ–¹æ³•<code>ThreadLocal#createInheritedMap()</code>ä½¿ç”¨çš„ã€‚</p>
<p>æ¥ç€çœ‹<code>ThreadLocalMap</code>æä¾›ç»™<code>ThreadLocal</code>ä½¿ç”¨çš„ä¸€äº›å®ä¾‹æ–¹æ³•ï¼š</p>
<pre><code class="java">// å¦‚æœKeyåœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾ä¸åˆ°å“ˆå¸Œæ§½çš„æ—¶å€™ä¼šè°ƒç”¨æ­¤æ–¹æ³•
private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) {
    Entry[] tab = table;
    int len = tab.length;
    // è¿™é‡Œä¼šé€šè¿‡nextIndexå°è¯•éå†æ•´ä¸ªå“ˆå¸Œè¡¨ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„Keyåˆ™è¿”å›Entry
    // å¦‚æœå“ˆå¸Œè¡¨ä¸­å­˜åœ¨Key == nullçš„æƒ…å†µï¼Œè°ƒç”¨expungeStaleEntryè¿›è¡Œæ¸…ç†
    while (e != null) {
        ThreadLocal&lt;?&gt; k = e.get();
        if (k == key)
            return e;
        if (k == null)
            expungeStaleEntry(i);
        else
            i = nextIndex(i, len);
        e = tab[i];
    }
    return null;
}

// 1.æ¸…ç©ºstaleSlotå¯¹åº”å“ˆå¸Œæ§½çš„Keyå’ŒValue
// 2.å¯¹staleSlotåˆ°ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½ä¹‹é—´çš„æ‰€æœ‰å¯èƒ½å†²çªçš„å“ˆå¸Œè¡¨éƒ¨åˆ†æ§½è¿›è¡Œé‡å“ˆå¸Œï¼Œç½®ç©ºKeyä¸ºnullçš„æ§½
// 3.æ³¨æ„è¿”å›å€¼æ˜¯staleSlotä¹‹åçš„ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œç 
private int expungeStaleEntry(int staleSlot) {
    Entry[] tab = table;
    int len = tab.length;

    // expunge entry at staleSlot
    // æ¸…ç©ºstaleSlotå¯¹åº”å“ˆå¸Œæ§½çš„Keyå’ŒValue
    tab[staleSlot].value = null;
    tab[staleSlot] = null;
    size--;

    // Rehash until we encounter null
    // ä¸‹é¢çš„è¿‡ç¨‹æ˜¯å¯¹staleSlotåˆ°ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½ä¹‹é—´çš„æ‰€æœ‰å¯èƒ½å†²çªçš„å“ˆå¸Œè¡¨éƒ¨åˆ†æ§½è¿›è¡Œé‡å“ˆå¸Œï¼Œç½®ç©ºKeyä¸ºnullçš„æ§½
    Entry e;
    int i;
    for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
        ThreadLocal&lt;?&gt; k = e.get();
        if (k == null) {
            e.value = null;
            tab[i] = null;
            size--;
        } else {
            int h = k.threadLocalHashCode &amp; (len - 1);
            if (h != i) {
                tab[i] = null;

                // Unlike Knuth 6.4 Algorithm R, we must scan until
                // null because multiple entries could have been stale.
                while (tab[h] != null)
                    h = nextIndex(h, len);
                tab[h] = e;
            }
        }
    }
    return i;
}

// è¿™é‡Œä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä½œç”¨æ˜¯æ›¿æ¢å“ˆå¸Œç ä¸ºstaleSlotçš„å“ˆå¸Œæ§½ä¸­Entryçš„å€¼
private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) {
    Entry[] tab = table;
    int len = tab.length;
    Entry e;

    // Back up to check for prior stale entry in current run.
    // We clean out whole runs at a time to avoid continual
    // incremental rehashing due to garbage collector freeing
    // up refs in bunches (i.e., whenever the collector runs).
    int slotToExpunge = staleSlot;
    // è¿™ä¸ªå¾ªç¯ä¸»è¦æ˜¯ä¸ºäº†æ‰¾åˆ°staleSlotä¹‹å‰çš„æœ€å‰é¢çš„ä¸€ä¸ªKeyä¸ºnullçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œç 
    for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))
        if (e.get() == null)
            slotToExpunge = i;

    // Find either the key or trailing null slot of run, whichever
    // occurs first
    // éå†staleSlotä¹‹åçš„å“ˆå¸Œæ§½ï¼Œå¦‚æœKeyåŒ¹é…åˆ™ç”¨è¾“å…¥å€¼æ›¿æ¢
    for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
        ThreadLocal&lt;?&gt; k = e.get();

        // If we find key, then we need to swap it
        // with the stale entry to maintain hash table order.
        // The newly stale slot, or any other stale slot
        // encountered above it, can then be sent to expungeStaleEntry
        // to remove or rehash all of the other entries in run.
        if (k == key) {
            e.value = value;
            tab[i] = tab[staleSlot];
            tab[staleSlot] = e;
            // Start expunge at preceding stale entry if it exists
            if (slotToExpunge == staleSlot)
                slotToExpunge = i;
            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
            return;
        }

        // If we didn&#39;t find stale entry on backward scan, the
        // first stale entry seen while scanning for key is the
        // first still present in the run.
        if (k == null &amp;&amp; slotToExpunge == staleSlot)
            slotToExpunge = i;
    }
    // KeyåŒ¹é…ä¸äº†ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ªå“ˆå¸Œæ§½
    // If key not found, put new entry in stale slot
    tab[staleSlot].value = null;
    tab[staleSlot] = new Entry(key, value);

    // è¿™é‡Œå¦‚æœå½“å‰çš„staleSlotå’Œæ‰¾åˆ°å‰ç½®çš„slotToExpungeä¸ä¸€è‡´ä¼šè¿›è¡Œä¸€æ¬¡æ¸…ç†
    // If there are any other stale entries in run, expunge them
    if (slotToExpunge != staleSlot)
        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
}

// å¯¹å½“å‰å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„Keyä¸ºnullçš„Entryè°ƒç”¨expungeStaleEntry
private void expungeStaleEntries() {
    Entry[] tab = table;
    int len = tab.length;
    for (int j = 0; j &lt; len; j++) {
        Entry e = tab[j];
        if (e != null &amp;&amp; e.get() == null)
            expungeStaleEntry(j);
    }
}

// æ¸…ç†ç¬¬iä¸ªå“ˆå¸Œæ§½ä¹‹åçš„nä¸ªå“ˆå¸Œæ§½ï¼Œå¦‚æœéå†çš„æ—¶å€™å‘ç°Entryçš„Keyä¸ºnullï¼Œåˆ™nä¼šé‡ç½®ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ï¼ŒexpungeStaleEntryæœ‰å¯èƒ½ä¼šé‡å“ˆå¸Œä½¿å¾—å“ˆå¸Œè¡¨é•¿åº¦å‘ç”Ÿå˜åŒ–
private boolean cleanSomeSlots(int i, int n) {
    boolean removed = false;
    Entry[] tab = table;
    int len = tab.length;
    do {
        i = nextIndex(i, len);
        Entry e = tab[i];
        if (e != null &amp;&amp; e.get() == null) {
            n = len;
            removed = true;
            i = expungeStaleEntry(i);
        }
    } while ( (n &gt;&gt;&gt;= 1) != 0);
    return removed;
}


/**
 * è¿™ä¸ªæ–¹æ³•ä¸»è¦ç»™`ThreadLocal#get()`è°ƒç”¨ï¼Œé€šè¿‡å½“å‰ThreadLocalå®ä¾‹è·å–å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„Entry
 *
 */
private Entry getEntry(ThreadLocal&lt;?&gt; key) {
    // è®¡ç®—Entryçš„å“ˆå¸Œå€¼
    int i = key.threadLocalHashCode &amp; (table.length - 1);
    Entry e = table[i]; 
    if (e != null &amp;&amp; e.get() == key)
        return e;
    else  // æ³¨æ„è¿™é‡Œï¼Œå¦‚æœeä¸ºnullæˆ–è€…Keyå¯¹ä¸ä¸Šï¼Œä¼šè°ƒç”¨getEntryAfterMiss
        return getEntryAfterMiss(key, i, e);
}

// é‡å“ˆå¸Œï¼Œå¿…è¦æ—¶è¿›è¡Œæ‰©å®¹
private void rehash() {
    // æ¸…ç†æ‰€æœ‰ç©ºçš„å“ˆå¸Œæ§½ï¼Œå¹¶ä¸”è¿›è¡Œé‡å“ˆå¸Œ
    expungeStaleEntries();

    // Use lower threshold for doubling to avoid hysteresis
    // å“ˆå¸Œè¡¨çš„å“ˆå¸Œå…ƒç´ ä¸ªæ•°å¤§äº3/4é˜ˆå€¼æ—¶å€™è§¦å‘æ‰©å®¹
    if (size &gt;= threshold - threshold / 4)
        resize();
}

// æ‰©å®¹ï¼Œç®€å•çš„æ‰©å¤§2å€çš„å®¹é‡        
private void resize() {
    Entry[] oldTab = table;
    int oldLen = oldTab.length;
    int newLen = oldLen * 2;
    Entry[] newTab = new Entry[newLen];
    int count = 0;

    for (Entry e : oldTab) {
        if (e != null) {
            ThreadLocal&lt;?&gt; k = e.get();
            if (k == null) {
                e.value = null; // Help the GC
            } else {
                int h = k.threadLocalHashCode &amp; (newLen - 1);
                while (newTab[h] != null)
                     h = nextIndex(h, newLen);
                newTab[h] = e;
                count++;
            }
        }
    }

    setThreshold(newLen);
    size = count;
    table = newTab;
}

// åŸºäºThreadLocalä½œä¸ºkeyï¼Œå¯¹å½“å‰çš„å“ˆå¸Œè¡¨è®¾ç½®å€¼ï¼Œæ­¤æ–¹æ³•ç”±`ThreadLocal#set()`è°ƒç”¨
private void set(ThreadLocal&lt;?&gt; key, Object value) {

    // We don&#39;t use a fast path as with get() because it is at
    // least as common to use set() to create new entries as
    // it is to replace existing ones, in which case, a fast
    // path would fail more often than not.

    Entry[] tab = table;
    int len = tab.length;
    int i = key.threadLocalHashCode &amp; (len-1);
    // å˜é‡å“ˆå¸Œè¡¨
    for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {
        ThreadLocal&lt;?&gt; k = e.get();
        // KeyåŒ¹é…ï¼Œç›´æ¥è®¾ç½®å€¼
        if (k == key) {
            e.value = value;
            return;
        }
        // å¦‚æœEntryçš„Keyä¸ºnullï¼Œåˆ™æ›¿æ¢è¯¥Keyä¸ºå½“å‰çš„keyï¼Œå¹¶ä¸”è®¾ç½®å€¼
        if (k == null) {
            replaceStaleEntry(key, value, i);
            return;
        }
    }

    tab[i] = new Entry(key, value);
    int sz = ++size;
    // æ¸…ç†å½“å‰æ–°è®¾ç½®å…ƒç´ çš„å“ˆå¸Œæ§½ä¸‹æ ‡åˆ°szæ®µçš„å“ˆå¸Œæ§½ï¼Œå¦‚æœæ¸…ç†æˆåŠŸå¹¶ä¸”szå¤§äºé˜ˆå€¼åˆ™è§¦å‘æ‰©å®¹
    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
        rehash();
}</code></pre>
<p>ç®€å•æ¥è¯´ï¼Œ<code>ThreadLocalMap</code>æ˜¯<code>ThreadLocal</code>çœŸæ­£çš„æ•°æ®å­˜å‚¨å®¹å™¨ï¼Œå®é™…ä¸Š<code>ThreadLocal</code>æ•°æ®æ“ä½œçš„å¤æ‚éƒ¨åˆ†çš„æ‰€æœ‰é€»è¾‘éƒ½åœ¨<code>ThreadLocalMap</code>ä¸­è¿›è¡Œï¼Œè€Œ<code>ThreadLocalMap</code>å®ä¾‹æ˜¯<code>Thread</code>çš„æˆå‘˜å˜é‡ï¼Œåœ¨<code>ThreadLocal#set()</code>æ–¹æ³•é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™è®¾ç½®åˆ°å½“å‰æ‰§è¡Œçš„çº¿ç¨‹å®ä¾‹ä¸­ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å¤šä¸ª<code>ThreadLocal</code>å®ä¾‹ï¼Œå®é™…ä¸Šï¼Œæ¯ä¸ª<code>ThreadLocal</code>å®ä¾‹å¯¹åº”çš„æ˜¯<code>ThreadLocalMap</code>çš„å“ˆå¸Œè¡¨ä¸­çš„ä¸€ä¸ªå“ˆå¸Œæ§½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸»å‡½æ•°ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨å¤šä¸ª<code>ThreadLocal</code>å®ä¾‹ï¼š</p>
<pre><code class="java">public class ThreadLocalMain {

    private static final ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;();
    private static final ThreadLocal&lt;String&gt; TL_2 = new ThreadLocal&lt;&gt;();
    private static final ThreadLocal&lt;Long&gt; TL_3 = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception {
        TL_1.set(1);
        TL_2.set(&quot;1&quot;);
        TL_3.set(1L);
        Field field = Thread.class.getDeclaredField(&quot;threadLocals&quot;);
        field.setAccessible(true);
        Object o = field.get(Thread.currentThread());
        System.out.println(o);
    }
}</code></pre>
<p>å®é™…ä¸Šï¼Œä¸»çº¿ç¨‹çš„threadLocalså±æ€§ä¸­çš„å“ˆå¸Œè¡¨ä¸­ä¸€èˆ¬ä¸æ­¢æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ä¸‰ä¸ª<code>ThreadLocal</code>ï¼Œå› ä¸ºåŠ è½½ä¸»çº¿ç¨‹çš„æ—¶å€™è¿˜æœ‰å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨åˆ°<code>ThreadLocal</code>ï¼Œç¬”è€…æŸæ¬¡Debugçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="/imag/Factory/image-20200219100739092.png" alt="main-ThreadLocal"></p>
<p>ç”¨PPTç”»å›¾ç®€åŒ–ä¸€ä¸‹ï¼š</p>
<p><img src="/imag/Factory/image-20200219100834253.png" alt="image-20200219100834253"></p>
<p>ä¸Šå›¾threadLocalHashCodeå±æ€§ä¸€è¡Œçš„è¡¨æ˜¯ä¸ºäº†æ ‡å‡ºæ¯ä¸ªEntryçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œå€¼ï¼Œå®é™…ä¸Šï¼ŒthreadLocalHashCodeæ˜¯<code>ThreadLocal@XXXX</code>ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œè¿™æ˜¯å¾ˆæ˜¾ç„¶çš„ï¼Œæœ¬æ¥threadLocalHashCodeå°±æ˜¯<code>ThreadLocal</code>çš„ä¸€ä¸ªæˆå‘˜å˜é‡ã€‚</p>
<p>ä¸Šé¢åªæ˜¯ç®€å•ç²—ç•¥å¯¹<code>ThreadLocalMap</code>çš„æºç è¿›è¡Œäº†æµæ°´è´¦çš„åˆ†æï¼Œä¸‹æ–‡ä¼šä½œä¸€äº›è¯¦ç»†çš„å›¾ï¼Œè¯´æ˜ä¸€ä¸‹<code>ThreadLocal</code>å’Œ<code>ThreadLocalMap</code>ä¸­çš„ä¸€äº›æ ¸å¿ƒæ“ä½œçš„è¿‡ç¨‹ã€‚</p>
<h3 id="ThreadLocalçš„åˆ›å»º"><a href="#ThreadLocalçš„åˆ›å»º" class="headerlink" title="ThreadLocalçš„åˆ›å»º"></a>ThreadLocalçš„åˆ›å»º</h3><p>ä»<code>ThreadLocal</code>çš„æ„é€ å‡½æ•°æ¥çœ‹ï¼Œ<code>ThreadLocal</code>å®ä¾‹çš„æ„é€ å¹¶ä¸ä¼šåšä»»ä½•æ“ä½œï¼Œåªæ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ª<code>ThreadLocal</code>çš„æ³›å‹å®ä¾‹ï¼Œåç»­å¯ä»¥æŠŠå®ƒä½œä¸º<code>ThreadLocalMap$Entry</code>çš„é”®ï¼š</p>
<pre><code class="java">// æ³¨æ„threadLocalHashCodeåœ¨æ¯ä¸ªæ–°`ThreadLocal`å®ä¾‹çš„æ„é€ åŒæ—¶å·²ç»ç¡®å®šäº†
private final int threadLocalHashCode = nextHashCode();
private static AtomicInteger nextHashCode = new AtomicInteger();
private static final int HASH_INCREMENT = 0x61c88647;
private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}

// é€šè¿‡Supplierå»è¦†ç›–initialValueæ–¹æ³•
public static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier) {
    return new SuppliedThreadLocal&lt;&gt;(supplier);
}

// é»˜è®¤å…¬æœ‰æ„é€ å‡½æ•°
public ThreadLocal() {

}</code></pre>
<p>æ³¨æ„threadLocalHashCodeåœ¨æ¯ä¸ªæ–°<code>ThreadLocal</code>å®ä¾‹çš„æ„é€ åŒæ—¶å·²ç»ç¡®å®šäº†ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯Entryå“ˆå¸Œè¡¨çš„å“ˆå¸Œæ§½ç»‘å®šçš„å“ˆå¸Œå€¼ã€‚</p>
<h3 id="TreadLocalçš„setæ–¹æ³•"><a href="#TreadLocalçš„setæ–¹æ³•" class="headerlink" title="TreadLocalçš„setæ–¹æ³•"></a>TreadLocalçš„setæ–¹æ³•</h3><p><code>ThreadLocal</code>ä¸­<code>set()</code>æ–¹æ³•çš„æºç å¦‚ä¸‹:</p>
<pre><code class="java">public void set(T value) {
    //è®¾ç½®å€¼å‰æ€»æ˜¯è·å–å½“å‰çº¿ç¨‹å®ä¾‹
    Thread t = Thread.currentThread();
    //ä»å½“å‰çº¿ç¨‹å®ä¾‹ä¸­è·å–threadLocalså±æ€§
    ThreadLocalMap map = getMap(t);
    if (map != null)
         //threadLocalså±æ€§ä¸ä¸ºnullåˆ™è¦†ç›–keyä¸ºå½“å‰çš„ThreadLocalå®ä¾‹ï¼Œå€¼ä¸ºvalue
         map.set(this, value);
    else
    //threadLocalså±æ€§ä¸ºnullï¼Œåˆ™åˆ›å»ºThreadLocalMapï¼Œç¬¬ä¸€ä¸ªé¡¹çš„Keyä¸ºå½“å‰çš„ThreadLocalå®ä¾‹ï¼Œå€¼ä¸ºvalue
        createMap(t, value);
}

// è¿™é‡Œçœ‹åˆ°è·å–ThreadLocalMapå®ä¾‹æ—¶å€™æ€»æ˜¯ä»çº¿ç¨‹å®ä¾‹çš„æˆå‘˜å˜é‡è·å–
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}

// åˆ›å»ºThreadLocalMapå®ä¾‹çš„æ—¶å€™ï¼Œä¼šæŠŠæ–°å®ä¾‹èµ‹å€¼åˆ°çº¿ç¨‹å®ä¾‹çš„threadLocalsæˆå‘˜
void createMap(Thread t, T firstValue) {
     t.threadLocals = new ThreadLocalMap(this, firstValue);
}</code></pre>
<p>ä¸Šé¢çš„è¿‡ç¨‹æºç å¾ˆç®€å•ï¼Œè®¾ç½®å€¼çš„æ—¶å€™æ€»æ˜¯å…ˆè·å–å½“å‰çº¿ç¨‹å®ä¾‹å¹¶ä¸”æ“ä½œå®ƒçš„å˜é‡threadLocalsã€‚æ­¥éª¤æ˜¯ï¼š</p>
<ul>
<li>è·å–å½“å‰è¿è¡Œçº¿ç¨‹çš„å®ä¾‹ã€‚</li>
<li>é€šè¿‡çº¿ç¨‹å®ä¾‹è·å–çº¿ç¨‹å®ä¾‹æˆå‘˜threadLocals(<code>ThreadLocalMap</code>)ï¼Œå¦‚æœä¸ºnullï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„<code>ThreadLocalMap</code>å®ä¾‹èµ‹å€¼åˆ°threadLocalsã€‚</li>
<li>é€šè¿‡threadLocalsè®¾ç½®å€¼valueï¼Œå¦‚æœåŸæ¥çš„å“ˆå¸Œæ§½å·²ç»å­˜åœ¨å€¼ï¼Œåˆ™è¿›è¡Œè¦†ç›–ã€‚</li>
</ul>
<p><img src="/imag/Factory/image-20200219101026615.png" alt="image-20200219101026615"></p>
<p><img src="/imag/Factory/image-20200219101048389.png" alt="image-20200219101048389"></p>
<p><img src="/imag/Factory/image-20200219101109099.png" alt="image-20200219101109099"></p>
<h3 id="TreadLocalçš„getæ–¹æ³•"><a href="#TreadLocalçš„getæ–¹æ³•" class="headerlink" title="TreadLocalçš„getæ–¹æ³•"></a>TreadLocalçš„getæ–¹æ³•</h3><p><code>ThreadLocal</code>ä¸­<code>get()</code>æ–¹æ³•çš„æºç å¦‚ä¸‹:</p>
<pre><code class="java"> public T get() {
   //è·å–å½“å‰çº¿ç¨‹çš„å®ä¾‹
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
    //æ ¹æ®å½“å‰çš„ThreadLocalå®ä¾‹è·å–ThreadLocalMapä¸­çš„Entryï¼Œä½¿ç”¨çš„æ˜¯ThreadLocalMapçš„getEntryæ–¹æ³•
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings(&quot;unchecked&quot;)
            T result = (T) e.value;
             return result;
            }
        }
    //çº¿ç¨‹å®ä¾‹ä¸­çš„threadLocalsä¸ºnullï¼Œåˆ™è°ƒç”¨initialValueæ–¹æ³•ï¼Œå¹¶ä¸”åˆ›å»ºThreadLocalMapèµ‹å€¼åˆ°threadLocals
    return setInitialValue();
}

private T setInitialValue() {
    // è°ƒç”¨initialValueæ–¹æ³•è·å–å€¼
    T value = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    // ThreadLocalMapå¦‚æœæœªåˆå§‹åŒ–åˆ™è¿›è¡Œä¸€æ¬¡åˆ›å»ºï¼Œå·²åˆå§‹åŒ–åˆ™ç›´æ¥è®¾ç½®å€¼
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
    return value;
}

protected T initialValue() {
     return null;
}</code></pre>
<p><code>initialValue()</code>æ–¹æ³•é»˜è®¤è¿”å›nullï¼Œå¦‚æœ<code>ThreadLocal</code>å®ä¾‹æ²¡æœ‰ä½¿ç”¨è¿‡<code>set()</code>æ–¹æ³•ç›´æ¥ä½¿ç”¨<code>get()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆ<code>ThreadLocalMap</code>ä¸­çš„æ­¤<code>ThreadLocal</code>ä¸ºKeyçš„é¡¹ä¼šæŠŠå€¼è®¾ç½®ä¸º<code>initialValue()</code>æ–¹æ³•çš„è¿”å›å€¼ã€‚å¦‚æœæƒ³æ”¹å˜è¿™ä¸ªé€»è¾‘å¯ä»¥å¯¹<code>initialValue()</code>æ–¹æ³•è¿›è¡Œè¦†ç›–ã€‚</p>
<img src="/imag/Factory/image-20200219101207550.png" alt="image-20200219101207550" style="zoom:50%;" />

<h3 id="TreadLocalçš„removeæ–¹æ³•"><a href="#TreadLocalçš„removeæ–¹æ³•" class="headerlink" title="TreadLocalçš„removeæ–¹æ³•"></a>TreadLocalçš„removeæ–¹æ³•</h3><p><code>ThreadLocal</code>ä¸­<code>remove()</code>æ–¹æ³•çš„æºç å¦‚ä¸‹:</p>
<pre><code class="java">public void remove() {
    //è·å–Threadå®ä¾‹ä¸­çš„ThreadLocalMap
    ThreadLocalMap m = getMap(Thread.currentThread());
    if (m != null)
       //æ ¹æ®å½“å‰ThreadLocalä½œä¸ºKeyå¯¹ThreadLocalMapçš„å…ƒç´ è¿›è¡Œç§»é™¤
       m.remove(this);
}</code></pre>
<p><img src="/imag/Factory/image-20200219101253773.png" alt="image-20200219101253773"></p>
<h2 id="ThreadLocal-ThreadLocalMapçš„åˆå§‹åŒ–"><a href="#ThreadLocal-ThreadLocalMapçš„åˆå§‹åŒ–" class="headerlink" title="ThreadLocal.ThreadLocalMapçš„åˆå§‹åŒ–"></a>ThreadLocal.ThreadLocalMapçš„åˆå§‹åŒ–</h2><p>æˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>java.lang.Thread</code>ç±»é‡Œé¢çš„å˜é‡ï¼š</p>
<pre><code class="java">public class Thread implements Runnable {

  //ä¼ é€’ThreadLocalä¸­çš„ThreadLocalMapå˜é‡
  ThreadLocal.ThreadLocalMap threadLocals = null;
  //ä¼ é€’InheritableThreadLocalä¸­çš„ThreadLocalMapå˜é‡
  ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}</code></pre>
<p>ä¹Ÿå°±æ˜¯ï¼Œ<code>ThreadLocal</code>éœ€è¦å­˜æ”¾å’Œè·å–çš„æ•°æ®å®é™…ä¸Šç»‘å®šåœ¨<code>Thread</code>å®ä¾‹çš„æˆå‘˜å˜é‡threadLocalsä¸­ï¼Œå¹¶ä¸”æ˜¯<code>ThreadLocal#set()</code>æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æ‰è¿›è¡Œ<strong>æ‡’åŠ è½½</strong>çš„ï¼Œå¯ä»¥ç»“åˆä¸Šä¸€èŠ‚çš„å†…å®¹ç†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚</p>
<h2 id="ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼"></a>ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</h2><p>å…¶å®<code>ThreadLocal</code>æœ¬èº«ä¸å­˜æ”¾ä»»ä½•çš„æ•°æ®ï¼Œè€Œ<code>ThreadLocal</code>ä¸­çš„æ•°æ®å®é™…ä¸Šæ˜¯å­˜æ”¾åœ¨çº¿ç¨‹å®ä¾‹ä¸­ï¼Œä»å®é™…æ¥çœ‹æ˜¯çº¿ç¨‹å†…å­˜æ³„æ¼ï¼Œåº•å±‚æ¥çœ‹æ˜¯<code>Thread</code>å¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡threadLocalsæŒæœ‰å¤§é‡çš„K-Vç»“æ„ï¼Œ<strong>å¹¶ä¸”çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçŠ¶æ€å¯¼è‡´å˜é‡threadLocalsæ— æ³•é‡Šæ”¾è¢«å›æ”¶</strong>ã€‚</p>
<p>threadLocalsæŒæœ‰å¤§é‡çš„K-Vç»“æ„è¿™ä¸€ç‚¹çš„å‰ææ˜¯è¦å­˜åœ¨å¤§é‡çš„<code>ThreadLocal</code>å®ä¾‹çš„å®šä¹‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªåº”ç”¨ä¸å¯èƒ½å®šä¹‰å¤§é‡çš„<code>ThreadLocal</code>ï¼Œ<strong>æ‰€ä»¥ä¸€èˆ¬çš„æ³„æ¼æºæ˜¯çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçŠ¶æ€å¯¼è‡´å˜é‡threadLocalsæ— æ³•é‡Šæ”¾è¢«å›æ”¶</strong>ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒÂ·ThreadLocalMapÂ·ä¸­çš„Entryç»“æ„çš„Keyç”¨åˆ°äº†å¼±å¼•ç”¨(Â·WeakReference&lt;ThreadLocal&lt;?&gt;&gt;Â·)ï¼Œå½“æ²¡æœ‰å¼ºå¼•ç”¨æ¥å¼•ç”¨<code>ThreadLocal</code>å®ä¾‹çš„æ—¶å€™ï¼ŒJVMçš„GCä¼šå›æ”¶<code>ThreadLocalMap</code>ä¸­çš„è¿™äº›Keyï¼Œæ­¤æ—¶ï¼Œ<code>ThreadLocalMap</code>ä¸­ä¼šå‡ºç°ä¸€äº›Keyä¸ºnullï¼Œä½†æ˜¯Valueä¸ä¸ºnullçš„Entryé¡¹ï¼Œè¿™äº›Entryé¡¹å¦‚æœä¸ä¸»åŠ¨æ¸…ç†ï¼Œå°±ä¼šä¸€ç›´é©»ç•™åœ¨ThreadLocalMapä¸­ã€‚ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<code>ThreadLocal</code>ä¸­<code>get()</code>ã€<code>set()</code>ã€<code>remove()</code>è¿™äº›æ–¹æ³•ä¸­éƒ½å­˜åœ¨æ¸…ç†<code>ThreadLocalMap</code>å®ä¾‹keyä¸ºnullçš„ä»£ç å—ã€‚æ€»ç»“ä¸‹æ¥ï¼Œå†…å­˜æ³„æ¼å¯èƒ½å‡ºç°çš„åœ°æ–¹æ˜¯ï¼š</p>
<ul>
<li><p>1ã€å¤§é‡åœ°(é™æ€)åˆå§‹åŒ–<code>ThreadLocal</code>å®ä¾‹ï¼Œåˆå§‹åŒ–ä¹‹åä¸å†è°ƒç”¨<code>get()</code>ã€<code>set()</code>ã€<code>remove()</code>æ–¹æ³•ã€‚</p>
</li>
<li><p>2ã€åˆå§‹åŒ–äº†å¤§é‡çš„<code>ThreadLocal</code>ï¼Œè¿™äº›<code>ThreadLocal</code>ä¸­å­˜æ”¾äº†å®¹é‡å¤§çš„Valueï¼Œå¹¶ä¸”ä½¿ç”¨äº†è¿™äº›<code>ThreadLocal</code>å®ä¾‹çš„çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçš„çŠ¶æ€ã€‚</p>
</li>
</ul>
<p><code>ThreadLocal</code>ä¸­ä¸€ä¸ªè®¾è®¡äº®ç‚¹æ˜¯<code>ThreadLocalMap</code>ä¸­çš„<code>Entry</code>ç»“æ„çš„Keyç”¨åˆ°äº†å¼±å¼•ç”¨ã€‚è¯•æƒ³å¦‚æœä½¿ç”¨å¼ºå¼•ç”¨ï¼Œç­‰äº<code>ThreadLocalMap</code>ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸<code>Thread</code>çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œè¿™æ ·å¾ˆå®¹æ˜“å‡ºç°å› ä¸ºå¤§é‡çº¿ç¨‹æŒç»­æ´»è·ƒå¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚ä½¿ç”¨äº†å¼±å¼•ç”¨çš„è¯ï¼ŒJVMè§¦å‘GCå›æ”¶å¼±å¼•ç”¨åï¼Œ<code>ThreadLocal</code>åœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨<code>get()</code>ã€<code>set()</code>ã€<code>remove()</code>æ–¹æ³•å°±å¯ä»¥åˆ é™¤é‚£äº›<code>ThreadLocalMap</code>ä¸­Keyä¸ºnullçš„å€¼ï¼Œèµ·åˆ°äº†<strong>æƒ°æ€§åˆ é™¤</strong>é‡Šæ”¾å†…å­˜çš„ä½œç”¨ã€‚</p>
<p>å…¶å®<code>ThreadLocal</code>åœ¨è®¾ç½®å†…éƒ¨ç±»<code>ThreadLocal.ThreadLocalMap</code>ä¸­æ„å»ºçš„Entryå“ˆå¸Œè¡¨å·²ç»è€ƒè™‘åˆ°å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ‰€ä»¥<code>ThreadLocal.ThreadLocalMap$Entry</code>ç±»è®¾è®¡ä¸ºå¼±å¼•ç”¨ï¼Œç±»ç­¾åä¸º<code>static class Entry extends WeakReference&gt;</code>ã€‚ä¹‹å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»è¿‡ï¼Œå¦‚æœå¼±å¼•ç”¨å…³è”çš„å¯¹è±¡å¦‚æœç½®ä¸ºnullï¼Œé‚£ä¹ˆè¯¥å¼±å¼•ç”¨ä¼šåœ¨ä¸‹ä¸€æ¬¡GCæ—¶å€™å›æ”¶å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre><code class="java">public class ThreadLocalMain {

    private static ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception {
        TL_1.set(1);
        TL_1 = null;
        System.gc();
        Thread.sleep(300);
    }
}</code></pre>
<p>è¿™ç§æƒ…å†µä¸‹ï¼ŒTL_1è¿™ä¸ª<code>ThreadLocal</code>åœ¨ä¸»åŠ¨GCä¹‹åï¼Œçº¿ç¨‹ç»‘å®šçš„<code>ThreadLocal.ThreadLocalMap</code>å®ä¾‹ä¸­çš„Entryå“ˆå¸Œè¡¨ä¸­åŸæ¥çš„TL_1æ‰€åœ¨çš„å“ˆå¸Œæ§½Entryçš„å¼•ç”¨æŒæœ‰å€¼referent(ç»§æ‰¿è‡ª<code>WeakReference</code>)ä¼šå˜æˆnullï¼Œä½†æ˜¯Entryä¸­çš„valueæ˜¯å¼ºå¼•ç”¨ï¼Œè¿˜å­˜æ”¾ç€TL_1è¿™ä¸ª<code>ThreadLocal</code>æœªå›æ”¶ä¹‹å‰çš„å€¼ã€‚è¿™äº›è¢«â€å­¤ç«‹â€çš„å“ˆå¸Œæ§½Entryå°±æ˜¯å‰é¢è¯´åˆ°çš„è¦<strong>æƒ°æ€§åˆ é™¤</strong>çš„å“ˆå¸Œæ§½ã€‚</p>
<h2 id="ThreadLocalçš„æœ€ä½³å®è·µ"><a href="#ThreadLocalçš„æœ€ä½³å®è·µ" class="headerlink" title="ThreadLocalçš„æœ€ä½³å®è·µ"></a>ThreadLocalçš„æœ€ä½³å®è·µ</h2><p>å…¶å®<code>ThreadLocal</code>çš„æœ€ä½³å®è·µå¾ˆç®€å•ï¼š</p>
<ul>
<li>æ¯æ¬¡ä½¿ç”¨å®Œ<code>ThreadLocal</code>å®ä¾‹ï¼Œéƒ½è°ƒç”¨å®ƒçš„<code>remove()</code>æ–¹æ³•ï¼Œæ¸…é™¤<code>Entry</code>ä¸­çš„æ•°æ®ã€‚</li>
</ul>
<p>è°ƒç”¨<code>remove()</code>æ–¹æ³•æœ€ä½³æ—¶æœºæ˜¯<strong>çº¿ç¨‹è¿è¡Œç»“æŸä¹‹å‰çš„<code>finally</code>ä»£ç å—</strong>ä¸­è°ƒç”¨ï¼Œè¿™æ ·èƒ½å®Œå…¨é¿å…æ“ä½œä¸å½“å¯¼è‡´çš„å†…å­˜æ³„æ¼ï¼Œè¿™ç§ä¸»åŠ¨æ¸…ç†çš„æ–¹å¼æ¯”æƒ°æ€§åˆ é™¤æœ‰æ•ˆã€‚</p>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ 729535228@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">èµ</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">æ–‡ç« æ ‡é¢˜:</span>ThreadLocalæºç è§£æ</p>
    <p><span class="copy-title">æ–‡ç« å­—æ•°:</span><span class="post-count">5.1k</span></p>
    <p><span class="copy-title">æœ¬æ–‡ä½œè€…:</span><a  title="Ocean Bai">Ocean Bai</a></p>
    <p><span class="copy-title">å‘å¸ƒæ—¶é—´:</span>2020-02-19, 09:41:31</p>
    <p><span class="copy-title">æœ€åæ›´æ–°:</span>2020-02-19, 10:18:17</p>
    <span class="copy-title">åŸå§‹é“¾æ¥:</span><a class="post-url" href="/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="ThreadLocalæºç è§£æ">http://yoursite.com/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a>
    <p>
        <span class="copy-title">ç‰ˆæƒå£°æ˜:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚
    </p>
</div>








    </div>
    <div class="copyright">
        <p class="footer-entry">Â©2019-2020 Ocean</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">ç›®å½•</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">Ã—</a>
    <div class="shang_tit">
        <p>å–œæ¬¢å°±ç‚¹èµ,ç–¼çˆ±å°±æ‰“èµ</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="æ‰«ç æ”¯æŒ">
            <img src="/img/weixin.jpg" class="weixin" title="æ‰«ç æ”¯æŒ">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">æ”¯ä»˜å®</label></span><span><label><input type="radio" name="pay" value="weixin">å¾®ä¿¡</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*ä½œè€…ã€æ ‡ç­¾çš„è‡ªåŠ¨è¡¥å…¨*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#åƒåœ¾','#ç®—æ³•','#ç±»åŠ è½½å™¨','#ç¼“å­˜','#è®¾è®¡åŸåˆ™','#åå°„','#è®¾è®¡æ¨¡å¼','#å·¥å‚æ¨¡å¼','#é¢è¯•','#æ€»ç»“é¢è¯•','#åŠ¨æ€ä»£ç†','#SPI','#jdk','#çº¿ç¨‹æ± ',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
        /* æ¸²æŸ“*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("//cdn.jsdelivr.net/npm/mermaid@8.4.2/dist/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&#34;theme&#34;:&#34;default&#34;,&#34;startOnLoad&#34;:true,&#34;flowchart&#34;:{&#34;useMaxWidth&#34;:false,&#34;htmlLabels&#34;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
