<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ThreadLocal源码解析 | Ride the waves</title>
  <meta name="keywords" content=" ThreadLocal ">
  <meta name="description" content="ThreadLocal源码解析 | Ride the waves">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="11月的最后一天，既是结束又是开始。希望我们都能够努力学习，坚持不懈的去追逐自己的梦想。古之立大事者，不惟有超世之才，亦必有坚忍不拔之志 心存迷惘 则无法继续前行">
<meta property="og:type" content="website">
<meta property="og:title" content="关于">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;about&#x2F;index.html">
<meta property="og:site_name" content="Ride the waves">
<meta property="og:description" content="11月的最后一天，既是结束又是开始。希望我们都能够努力学习，坚持不懈的去追逐自己的梦想。古之立大事者，不惟有超世之才，亦必有坚忍不拔之志 心存迷惘 则无法继续前行">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-21T03:41:40.400Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Ocean Bai</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/oceanbai" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(62)</small></div></li>
    
        
            
            <li><div data-rel="Redis">Redis<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="java基础"><i class="fold iconfont icon-right"></i>java基础<small>(16)</small></div>
                
                    <ul class="sub hide">
                        
                        <li><div data-rel="JVM">JVM<small>(2)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="JDK">JDK<small>(8)</small></div>
                            
                        </li>
                            
                        <li><div data-rel="java并发">java并发<small>(3)</small></div>
                            
                        </li>
                            
                    </ul>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Spring">Spring<small>(8)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="算法">算法<small>(4)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
            <li><div data-rel="dubbo">dubbo<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Mysql">Mysql<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="设计模式">设计模式<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="网络知识">网络知识<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="设计原则">设计原则<small>(7)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="面试练习">面试练习<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="面试">面试<small>(9)</small></div>
                
            </li>
            
        
    
        
            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="62">
<input type="hidden" id="yelog_site_word_count" value="189.1k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="Search..." autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color3">面试</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">Redis</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">jvm</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">类加载器</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">垃圾</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">AOP</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">算法</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">反射</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">缓存</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">IOC</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">SpringBoot常用注解</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">SPI</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">动态代理</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">mysql</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">日志系统</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">索引</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">设计模式</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">工厂模式</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">事务</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">三次握手</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">四次挥手</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">设计原则</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">练习</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">总结面试</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">java</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">多态</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">指令</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">arrayList</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">Volatile</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">ThreadLocal</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">hashmap</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">内存模型</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">线程池</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">synchronized</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class="面试 "
           href="/2020/03/14/%E9%9D%A2%E8%AF%95/%E5%87%86%E5%A4%87/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="面试准备">面试准备</span>
            <span class="post-date" title="2020-03-14 21:41:31">2020/03/14</span>
        </a>
        
        <a  class="面试 "
           href="/2020/03/08/%E9%9D%A2%E8%AF%95/3%E6%9C%888%E5%8F%B7%E5%89%8D%E7%9A%84%E9%9D%A2%E8%AF%95/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="3月8号前的面试">3月8号前的面试</span>
            <span class="post-date" title="2020-03-08 21:41:31">2020/03/08</span>
        </a>
        
        <a  class="面试 "
           href="/2020/03/08/%E9%9D%A2%E8%AF%95/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="从零开始">从零开始</span>
            <span class="post-date" title="2020-03-08 12:05:00">2020/03/08</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/03/03/java/JDK/%E5%A4%9A%E6%80%81%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/"
           data-tag="java,多态"
           data-author="" >
            <span class="post-title" title="重载、重写的调用原理">重载、重写的调用原理</span>
            <span class="post-date" title="2020-03-03 12:41:32">2020/03/03</span>
        </a>
        
        <a  class="面试 "
           href="/2020/02/28/%E9%9D%A2%E8%AF%95/FORK%E5%9C%B0%E5%9D%80/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="FORK地址">FORK地址</span>
            <span class="post-date" title="2020-02-28 21:41:31">2020/02/28</span>
        </a>
        
        <a  class="面试 "
           href="/2020/02/28/%E9%9D%A2%E8%AF%95/%E4%BA%94%E8%BD%AE%E9%98%BF%E9%87%8C%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8A%E7%AD%94%E6%A1%88/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="五轮阿里面试题及答案">五轮阿里面试题及答案</span>
            <span class="post-date" title="2020-02-28 21:41:31">2020/02/28</span>
        </a>
        
        <a  class="面试练习 "
           href="/2020/02/26/%E7%BB%83%E4%B9%A0/2020-02-26%E7%BB%83%E4%B9%A0%E6%80%BB%E7%BB%93/"
           data-tag="练习"
           data-author="" >
            <span class="post-title" title="2020-02-26练习总结">2020-02-26练习总结</span>
            <span class="post-date" title="2020-02-26 09:41:31">2020/02/26</span>
        </a>
        
        <a  class="java基础 java并发 "
           href="/2020/02/23/java/%E5%B9%B6%E5%8F%91/Java%20Volatile/"
           data-tag="java,Volatile"
           data-author="" >
            <span class="post-title" title="Java Volatile">Java Volatile</span>
            <span class="post-date" title="2020-02-23 10:41:31">2020/02/23</span>
        </a>
        
        <a  class="java基础 java并发 "
           href="/2020/02/23/java/%E5%B9%B6%E5%8F%91/java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/"
           data-tag="java,内存模型"
           data-author="" >
            <span class="post-title" title="java内存模型">java内存模型</span>
            <span class="post-date" title="2020-02-23 10:41:31">2020/02/23</span>
        </a>
        
        <a  class="java基础 java并发 "
           href="/2020/02/23/java/%E5%B9%B6%E5%8F%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E5%B9%B6%E5%8F%91%E4%B9%8Bsynchronized%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"
           data-tag="java,synchronized"
           data-author="" >
            <span class="post-title" title="深入理解Java并发之synchronized实现原理">深入理解Java并发之synchronized实现原理</span>
            <span class="post-date" title="2020-02-23 10:41:31">2020/02/23</span>
        </a>
        
        <a  class="网络知识 "
           href="/2020/02/22/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8Band%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/"
           data-tag="三次握手,四次挥手"
           data-author="" >
            <span class="post-title" title="三次握手and四次挥手">三次握手and四次挥手</span>
            <span class="post-date" title="2020-02-22 16:41:31">2020/02/22</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/20/Spring/AOP/"
           data-tag="AOP"
           data-author="" >
            <span class="post-title" title="Spring AOP 简单流程与使用">Spring AOP 简单流程与使用</span>
            <span class="post-date" title="2020-02-20 15:41:31">2020/02/20</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/19/java/JDK/JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%BA%90%E7%A0%81/"
           data-tag="动态代理"
           data-author="" >
            <span class="post-title" title="JDK动态代理源码">JDK动态代理源码</span>
            <span class="post-date" title="2020-02-19 16:41:31">2020/02/19</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/19/java/JDK/CGlib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"
           data-tag="动态代理"
           data-author="" >
            <span class="post-title" title="CGlib动态代理源码">CGlib动态代理源码</span>
            <span class="post-date" title="2020-02-19 16:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/IoC%20%E4%B9%8B%E5%BC%80%E5%90%AF%20Bean%20%E7%9A%84%E5%8A%A0%E8%BD%BD/"
           data-tag="IOC"
           data-author="" >
            <span class="post-title" title="IoC 之开启 Bean 的加载">IoC 之开启 Bean 的加载</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/IoC%20%E4%B9%8B%E5%8A%A0%E8%BD%BD%20BeanDefinition/"
           data-tag="IOC"
           data-author="" >
            <span class="post-title" title="IoC 之加载 BeanDefinition">IoC 之加载 BeanDefinition</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/IoC%20%E4%B9%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Spring%20IoC/"
           data-tag="IOC"
           data-author="" >
            <span class="post-title" title="IoC 之深入理解 Spring IoC">IoC 之深入理解 Spring IoC</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/Spring%20AOP%20%E4%B9%8B%20%E7%90%86%E8%AE%BA%E7%AF%87/"
           data-tag="AOP"
           data-author="" >
            <span class="post-title" title="Spring AOP 之 理论篇">Spring AOP 之 理论篇</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/IoC%20%E4%B9%8B%E8%8E%B7%E5%8F%96%E9%AA%8C%E8%AF%81%E6%A8%A1%E5%9E%8B/"
           data-tag="IOC"
           data-author="" >
            <span class="post-title" title="IoC 之获取验证模型">IoC 之获取验证模型</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="Spring "
           href="/2020/02/19/Spring/%E9%9D%A2%E8%AF%95%E9%97%AE%E7%83%82%E7%9A%84%20Spring%20IOC%20%E8%BF%87%E7%A8%8B/"
           data-tag="IOC"
           data-author="" >
            <span class="post-title" title="面试问烂的 Spring IOC 过程">面试问烂的 Spring IOC 过程</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"
           data-tag="ThreadLocal"
           data-author="" >
            <span class="post-title" title="ThreadLocal源码解析">ThreadLocal源码解析</span>
            <span class="post-date" title="2020-02-19 09:41:31">2020/02/19</span>
        </a>
        
        <a  class="面试 "
           href="/2020/02/18/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E6%8A%80%E6%9C%AF%E6%A0%88/"
           data-tag="面试,总结面试"
           data-author="" >
            <span class="post-title" title="面试技术栈">面试技术栈</span>
            <span class="post-date" title="2020-02-18 16:41:32">2020/02/18</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/17/dubbo/dubboSPI/"
           data-tag="SPI"
           data-author="" >
            <span class="post-title" title="dubboSPI详解">dubboSPI详解</span>
            <span class="post-date" title="2020-02-17 14:41:31">2020/02/17</span>
        </a>
        
        <a  class="面试 "
           href="/2020/02/17/%E9%9D%A2%E8%AF%95/%E7%BE%8E%E5%9B%A2%E7%A0%94%E7%A9%B6%E7%94%9F%E5%AE%9E%E4%B9%A0%E7%94%9F/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="美团研究生实习生">美团研究生实习生</span>
            <span class="post-date" title="2020-02-17 11:41:31">2020/02/17</span>
        </a>
        
        <a  class=""
           href="/2020/02/17/%E7%AE%97%E6%B3%95/%E5%9F%BA%E6%9C%AC%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="算法/基本排序算法">算法/基本排序算法</span>
            <span class="post-date" title="2020-02-17 10:46:52">2020/02/17</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/15/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="适配器模式----不兼容结构的协调----六">适配器模式----不兼容结构的协调----六</span>
            <span class="post-date" title="2020-02-15 21:42:31">2020/02/15</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/15/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="桥接模式----处理多维变化----五">桥接模式----处理多维变化----五</span>
            <span class="post-date" title="2020-02-15 21:42:31">2020/02/15</span>
        </a>
        
        <a  class="面试 "
           href="/2020/02/15/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E9%A2%98/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="面试题">面试题</span>
            <span class="post-date" title="2020-02-15 21:41:32">2020/02/15</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/14/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="模板方法模式--------四">模板方法模式--------四</span>
            <span class="post-date" title="2020-02-14 16:38:31">2020/02/14</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/13/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式,工厂模式"
           data-author="" >
            <span class="post-title" title="抽象工厂模式--------三">抽象工厂模式--------三</span>
            <span class="post-date" title="2020-02-13 21:41:31">2020/02/13</span>
        </a>
        
        <a  class="java基础 JVM "
           href="/2020/02/12/java/java%E5%BC%95%E7%94%A8/"
           data-tag="jvm"
           data-author="" >
            <span class="post-title" title="深入解析强引用、软引用、弱引用、幻象引用">深入解析强引用、软引用、弱引用、幻象引用</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="java基础 JVM "
           href="/2020/02/12/java/JVM%E7%BB%84%E6%88%90%E8%A7%A3%E6%9E%90/"
           data-tag="jvm"
           data-author="" >
            <span class="post-title" title="JVM组成解析">JVM组成解析</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="java基础 "
           href="/2020/02/12/java/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8(ClassLoader)/"
           data-tag="类加载器"
           data-author="" >
            <span class="post-title" title="深入理解java类加载器(ClassLoader)">深入理解java类加载器(ClassLoader)</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="java基础 "
           href="/2020/02/12/java/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF(Class%E5%AF%B9%E8%B1%A1)%E4%B8%8E%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"
           data-tag="反射"
           data-author="" >
            <span class="post-title" title="深入理解Java类型信息(Class对象)与反射机制">深入理解Java类型信息(Class对象)与反射机制</span>
            <span class="post-date" title="2020-02-12 21:41:31">2020/02/12</span>
        </a>
        
        <a  class="算法 "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E5%9B%9E%E6%96%87%E6%95%B0/"
           data-tag="算法"
           data-author="" >
            <span class="post-title" title="回文数">回文数</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="算法 "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E7%BC%93%E5%AD%98%E7%AE%97%E6%B3%95------FIFO%20%E3%80%81LRU%E3%80%81LFU/"
           data-tag="缓存"
           data-author="" >
            <span class="post-title" title="缓存算法（FIFO、LRU、LFU）">缓存算法（FIFO、LRU、LFU）</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="算法 "
           href="/2020/02/12/%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95%E9%A2%9803-%E6%95%B0%E7%BB%84%E4%B8%AD%E9%87%8D%E5%A4%8D%E7%9A%84%E6%95%B0%E5%AD%97/"
           data-tag="算法"
           data-author="" >
            <span class="post-title" title="面试题03-数组中重复的数字">面试题03-数组中重复的数字</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/12/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式,工厂模式"
           data-author="" >
            <span class="post-title" title="工厂方法模式--------二">工厂方法模式--------二</span>
            <span class="post-date" title="2020-02-12 10:22:00">2020/02/12</span>
        </a>
        
        <a  class="java基础 "
           href="/2020/02/11/java/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"
           data-tag="垃圾"
           data-author="" >
            <span class="post-title" title="垃圾回收">垃圾回收</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/11/dubbo/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20RPC%20%E4%B9%8B%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%AF%87/"
           data-tag="动态代理"
           data-author="" >
            <span class="post-title" title="深入理解 RPC 之动态代理篇">深入理解 RPC 之动态代理篇</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="dubbo "
           href="/2020/02/11/dubbo/dubbo%E9%9D%A2%E8%AF%95%E9%A2%98/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="dubbo面试题">dubbo面试题</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="设计模式 "
           href="/2020/02/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"
           data-tag="设计模式,工厂模式"
           data-author="" >
            <span class="post-title" title="简单工厂模式--------一">简单工厂模式--------一</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/11/java/JDK/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%A7%A3%E6%9E%90/"
           data-tag="线程池"
           data-author="" >
            <span class="post-title" title="线程池源码解析Executor">线程池源码解析Executor</span>
            <span class="post-date" title="2020-02-11 21:41:31">2020/02/11</span>
        </a>
        
        <a  class="Mysql "
           href="/2020/02/01/mysql/02%7C%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E3%80%82redolog%E4%B8%8Ebinlog/"
           data-tag="mysql,日志系统"
           data-author="" >
            <span class="post-title" title="02|日志系统。redolog与binlog">02|日志系统。redolog与binlog</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class="Mysql "
           href="/2020/02/01/mysql/04%20%7C%20%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95/"
           data-tag="mysql,索引"
           data-author="" >
            <span class="post-title" title="04 | 深入浅出索引">04 | 深入浅出索引</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class="Mysql "
           href="/2020/02/01/mysql/03%20%7C%20%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB/"
           data-tag="mysql,事务"
           data-author="" >
            <span class="post-title" title="03 | 事务隔离">03 | 事务隔离</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/01/java/JDK/%E6%9F%A5%E7%9C%8BJava%E7%9A%84%E6%B1%87%E7%BC%96%E6%8C%87%E4%BB%A4/"
           data-tag="java,指令"
           data-author="" >
            <span class="post-title" title="查看Java的汇编指令">查看Java的汇编指令</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/01/java/JDK/ArrayList%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"
           data-tag="java,arrayList"
           data-author="" >
            <span class="post-title" title="ArrayList源码解析">ArrayList源码解析</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class="java基础 JDK "
           href="/2020/02/01/java/JDK/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%88%86%E6%9E%90HashMap/"
           data-tag="java,hashmap"
           data-author="" >
            <span class="post-title" title="深入浅出分析HashMap">深入浅出分析HashMap</span>
            <span class="post-date" title="2020-02-01 16:41:32">2020/02/01</span>
        </a>
        
        <a  class=""
           href="/2020/01/29/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/epoll%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E5%8F%8Aepoll%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="网络知识/epoll原理详解及epoll反应堆模型">网络知识/epoll原理详解及epoll反应堆模型</span>
            <span class="post-date" title="2020-01-29 22:21:02">2020/01/29</span>
        </a>
        
        <a  class="算法 "
           href="/2019/11/30/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%8F%89%E5%A0%86/"
           data-tag="算法"
           data-author="" >
            <span class="post-title" title="二叉堆">二叉堆</span>
            <span class="post-date" title="2019-11-30 21:49:13">2019/11/30</span>
        </a>
        
        <a  class="面试 "
           href="/2019/11/30/%E9%9D%A2%E8%AF%95/%E9%9D%A2%E8%AF%95%E8%A6%81%E6%B1%82/"
           data-tag="面试"
           data-author="" >
            <span class="post-title" title="别人面试要求">别人面试要求</span>
            <span class="post-date" title="2019-11-30 21:41:31">2019/11/30</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第三原则:单一职责原则">第三原则:单一职责原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E4%BE%9D%E8%B5%96%E5%80%92%E7%BD%AE%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第二原则:依赖倒置原则">第二原则:依赖倒置原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第六原则:里氏替换原则">第六原则:里氏替换原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第一原则:开闭原则">第一原则:开闭原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第四原则:接口隔离原则">第四原则:接口隔离原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E5%90%88%E6%88%90%E5%A4%8D%E7%94%A8%E5%8E%9F%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第七原则:合成复用原则">第七原则:合成复用原则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="设计原则 "
           href="/2019/05/26/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/%E8%BF%AA%E7%B1%B3%E7%89%B9%E6%B3%95%E5%88%99/"
           data-tag="设计原则"
           data-author="" >
            <span class="post-title" title="第五原则:迪米特法则">第五原则:迪米特法则</span>
            <span class="post-date" title="2019-05-26 17:07:00">2019/05/26</span>
        </a>
        
        <a  class="Spring "
           href="/2019/03/03/Spring/SpringBoot%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/"
           data-tag="SpringBoot常用注解"
           data-author="" >
            <span class="post-title" title="SpringBoot常用注解">SpringBoot常用注解</span>
            <span class="post-date" title="2019-03-03 11:41:31">2019/03/03</span>
        </a>
        
        <a  class="Redis "
           href="/2019/03/01/Redis/Redis%E9%9D%A2%E8%AF%95%E5%87%A0%E9%97%AE/"
           data-tag="面试,Redis"
           data-author="" >
            <span class="post-title" title="Redis之问几个你不了解的问题">Redis之问几个你不了解的问题</span>
            <span class="post-date" title="2019-03-01 21:41:31">2019/03/01</span>
        </a>
        
        <a  class="Redis "
           href="/2019/03/01/Redis/Redis%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/"
           data-tag="面试,Redis"
           data-author="" >
            <span class="post-title" title="Redis之问几个你不了解的问题">Redis之问几个你不了解的问题</span>
            <span class="post-date" title="2019-03-01 21:41:31">2019/03/01</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-java/JDK/ThreadLocal源码解析" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">ThreadLocal源码解析</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a  data-rel="java基础">java基础</a>/
            
                <a  data-rel="JDK">JDK</a>
            
        </span>
        
        
        <span class="tag">
            
            <a class="color2">ThreadLocal</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2020-03-03 11:58:15'>2020-02-19 09:41</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:5.1k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadLocal源码分析-黄金分割数的使用"><span class="toc-text">ThreadLocal源码分析-黄金分割数的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前提"><span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal是什么"><span class="toc-text">ThreadLocal是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal的概括图"><span class="toc-text">ThreadLocal的概括图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal的原理"><span class="toc-text">ThreadLocal的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal源码分析"><span class="toc-text">ThreadLocal源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal的内部属性"><span class="toc-text">ThreadLocal的内部属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内部类ThreadLocalMap的基本结构和源码分析"><span class="toc-text">内部类ThreadLocalMap的基本结构和源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal的创建"><span class="toc-text">ThreadLocal的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocal的set方法"><span class="toc-text">TreadLocal的set方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocal的get方法"><span class="toc-text">TreadLocal的get方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TreadLocal的remove方法"><span class="toc-text">TreadLocal的remove方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal-ThreadLocalMap的初始化"><span class="toc-text">ThreadLocal.ThreadLocalMap的初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么情况下ThreadLocal的使用会导致内存泄漏"><span class="toc-text">什么情况下ThreadLocal的使用会导致内存泄漏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal的最佳实践"><span class="toc-text">ThreadLocal的最佳实践</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ThreadLocal源码分析-黄金分割数的使用"><a href="#ThreadLocal源码分析-黄金分割数的使用" class="headerlink" title="ThreadLocal源码分析-黄金分割数的使用"></a>ThreadLocal源码分析-黄金分割数的使用</h1><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>最近接触到的一个项目要兼容新老系统，最终采用了<code>ThreadLocal</code>(实际上用的是<code>InheritableThreadLocal</code>)用于在子线程获取父线程中共享的变量。问题是解决了，但是后来发现对<code>ThreadLocal</code>的理解不够深入，于是顺便把它的源码阅读理解了一遍。在谈到<code>ThreadLocal</code>之前先卖个关子，先谈谈黄金分割数。本文在阅读<code>ThreadLocal</code>源码的时候是使用JDK8(1.8.0_181)。</p>
<h2 id="ThreadLocal是什么"><a href="#ThreadLocal是什么" class="headerlink" title="ThreadLocal是什么"></a>ThreadLocal是什么</h2><p>下面引用<code>ThreadLocal</code>的API注释：</p>
<blockquote>
<p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)</p>
</blockquote>
<p>稍微翻译一下：<code>ThreadLocal</code>提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问<code>ThreadLocal</code>实例的时候（通过其get或set方法）都有自己的、独立初始化的变量副本。<code>ThreadLocal</code>实例通常是类中的私有静态字段，使用它的目的是希望将状态（例如，用户ID或事务ID）与线程关联起来。</p>
<p><code>ThreadLocal</code>由Java界的两个大师级的作者编写，Josh Bloch和Doug Lea。Josh Bloch是JDK5语言增强、Java集合(Collection)框架的创办人以及《Effective Java》系列的作者。Doug Lea是JUC(<code>java.util.concurrent</code>)包的作者，Java并发编程的泰斗。所以，<code>ThreadLocal</code>的源码十分值得学习。</p>
<h2 id="ThreadLocal的概括图"><a href="#ThreadLocal的概括图" class="headerlink" title="ThreadLocal的概括图"></a>ThreadLocal的概括图</h2><p><img src="/imag/Factory/ThreadLocal%E7%BB%93%E6%9E%84.jpg" alt="ThreadLocal结构"></p>
<h2 id="ThreadLocal的原理"><a href="#ThreadLocal的原理" class="headerlink" title="ThreadLocal的原理"></a>ThreadLocal的原理</h2><p><code>ThreadLocal</code>虽然叫线程本地(局部)变量，但是实际上它并不存放任何的信息，可以这样理解：<strong>它是线程(<code>Thread</code>)操作<code>ThreadLocalMap</code>中存放的变量的桥梁</strong>。它主要提供了初始化、<code>set()</code>、<code>get()</code>、<code>remove()</code>几个方法。这样说可能有点抽象，下面画个图说明一下在线程中使用<code>ThreadLocal</code>实例的<code>set()</code>和<code>get()</code>方法的简单流程图。</p>
<p>假设我们有如下的代码，主线程的线程名字是main(也有可能不是main)：</p>
<pre><code class="java">public class Main {

    private static final ThreadLocal&lt;String&gt; LOCAL = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception{
        LOCAL.set(&quot;doge&quot;);
        System.out.println(LOCAL.get());
    }
}</code></pre>
<p>线程实例和<code>ThreadLocal</code>实例的关系如下：</p>
<p><img src="/imag/Factory/image-20200219100146621.png" alt="image-20200219100146621"></p>
<p>上面只描述了单线程的情况并且因为是主线程忽略了<code>Thread t = new Thread()</code>这一步，如果有多个线程会稍微复杂一些，但是原理是不变的，<code>ThreadLocal</code>实例总是通过<code>Thread.currentThread()</code><strong>获取到当前操作线程实例</strong>，然后去操作线程实例中的<code>ThreadLocalMap</code>类型的成员变量，因此它是一个桥梁，本身不具备存储功能。</p>
<h2 id="ThreadLocal源码分析"><a href="#ThreadLocal源码分析" class="headerlink" title="ThreadLocal源码分析"></a>ThreadLocal源码分析</h2><p>对于<code>ThreadLocal</code>的源码，我们需要重点关注<code>set()</code>、<code>get()</code>、<code>remove()</code>几个方法。</p>
<h3 id="ThreadLocal的内部属性"><a href="#ThreadLocal的内部属性" class="headerlink" title="ThreadLocal的内部属性"></a>ThreadLocal的内部属性</h3><pre><code class="java">//获取下一个ThreadLocal实例的哈希魔数
private final int threadLocalHashCode = nextHashCode();

//原子计数器，主要到它被定义为静态
private static AtomicInteger nextHashCode = new AtomicInteger();

//哈希魔数(增长数)，也是带符号的32位整型值黄金分割值的取正
private static final int HASH_INCREMENT = 0x61c88647;

//生成下一个哈希魔数
private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}</code></pre>
<p>这里需要注意一点，threadLocalHashCode是一个final的属性，而原子计数器变量nextHashCode和生成下一个哈希魔数的方法<code>nextHashCode()</code>是静态变量和静态方法，静态变量只会初始化一次。换而言之，每新建一个<code>ThreadLocal</code>实例，它内部的threadLocalHashCode就会增加0x61c88647。举个例子：</p>
<pre><code class="java">//t1中的threadLocalHashCode变量为0x61c88647
ThreadLocal t1 = new ThreadLocal();
//t2中的threadLocalHashCode变量为0x61c88647 + 0x61c88647
ThreadLocal t2 = new ThreadLocal();
//t3中的threadLocalHashCode变量为0x61c88647 + 0x61c88647 + 0x61c88647
ThreadLocal t3 = new ThreadLocal();</code></pre>
<p>threadLocalHashCode是下面的<code>ThreadLocalMap</code>结构中使用的哈希算法的核心变量，对于每个<code>ThreadLocal</code>实例，它的threadLocalHashCode是唯一的。</p>
<h3 id="内部类ThreadLocalMap的基本结构和源码分析"><a href="#内部类ThreadLocalMap的基本结构和源码分析" class="headerlink" title="内部类ThreadLocalMap的基本结构和源码分析"></a>内部类ThreadLocalMap的基本结构和源码分析</h3><p><code>ThreadLocal</code>内部类<code>ThreadLocalMap</code>使用了默认修饰符，也就是包(包私有)可访问的。<code>ThreadLocalMap</code>内部定义了一个静态类<code>Entry</code>。我们重点看下<code>ThreadLocalMap</code>的源码，先看成员和结构部分：</p>
<pre><code class="java">/**
 * ThreadLocalMap是一个定制的散列映射，仅适用于维护线程本地变量。
 * 它的所有方法都是定义在ThreadLocal类之内。
 * 它是包私有的，所以在Thread类中可以定义ThreadLocalMap作为变量。
 * 为了处理非常大(指的是值)和长时间的用途，哈希表的Key使用了弱引用(WeakReferences)。
 * 引用的队列(弱引用)不再被使用的时候，对应的过期的条目就能通过主动删除移出哈希表。
 */
static class ThreadLocalMap {

        //注意这里的Entry的Key为WeakReference&lt;ThreadLocal&lt;?&gt;&gt;
    static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; {

        //这个是真正的存放的值
        Object value;
                // Entry的Key就是ThreadLocal实例本身，Value就是输入的值
        Entry(ThreadLocal&lt;?&gt; k, Object v) {
                    super(k);
                    value = v;
                }
    }
        //初始化容量，必须是2的幂次方
    private static final int INITIAL_CAPACITY = 16;

        //哈希(Entry)表，必须时扩容，长度必须为2的幂次方
    private Entry[] table;

        //哈希表中元素(Entry)的个数
    private int size = 0;

        //下一次需要扩容的阈值，默认值为0
    private int threshold;

        //设置下一次需要扩容的阈值，设置值为输入值len的三分之二
    private void setThreshold(int len) {
        threshold = len * 2 / 3;
    }

    // 以len为模增加i
    private static int nextIndex(int i, int len) {
        return ((i + 1 &lt; len) ? i + 1 : 0);
    }

    // 以len为模减少i
    private static int prevIndex(int i, int len) {
        return ((i - 1 &gt;= 0) ? i - 1 : len - 1);
    }
}</code></pre>
<p>这里注意到十分重要的一点：<strong><code>ThreadLocalMap$Entry</code>是<code>WeakReference</code>(弱引用)，并且键值Key为<code>ThreadLocal</code>实例本身，这里使用了无限定的泛型通配符</strong>。</p>
<p>接着看<code>ThreadLocalMap</code>的构造函数：</p>
<pre><code class="java">// 构造ThreadLocal时候使用，对应ThreadLocal的实例方法void createMap(Thread t, T firstValue)
ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
    // 哈希表默认容量为16
    table = new Entry[INITIAL_CAPACITY];
    // 计算第一个元素的哈希码
    int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);
    table[i] = new Entry(firstKey, firstValue);
    size = 1;
    setThreshold(INITIAL_CAPACITY);
}

// 构造InheritableThreadLocal时候使用，基于父线程的ThreadLocalMap里面的内容进行提取放入新的ThreadLocalMap的哈希表中
// 对应ThreadLocal的静态方法static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap)
private ThreadLocalMap(ThreadLocalMap parentMap) {
    Entry[] parentTable = parentMap.table;
    int len = parentTable.length;
    setThreshold(len);
    table = new Entry[len];
    // 基于父ThreadLocalMap的哈希表进行拷贝
    for (Entry e : parentTable) {
        if (e != null) {
            @SuppressWarnings(&quot;unchecked&quot;)
            ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get();
            if (key != null) {
                Object value = key.childValue(e.value);
                Entry c = new Entry(key, value);
                int h = key.threadLocalHashCode &amp; (len - 1);
                while (table[h] != null)
                    h = nextIndex(h, len);
                table[h] = c;
                size++;
            }
        }
    }
}</code></pre>
<p>这里注意一下，<code>ThreadLocal</code>的<code>set()</code>方法调用的时候会懒初始化一个<code>ThreadLocalMap</code>并且放入第一个元素。而<code>ThreadLocalMap</code>的私有构造是提供给静态方法<code>ThreadLocal#createInheritedMap()</code>使用的。</p>
<p>接着看<code>ThreadLocalMap</code>提供给<code>ThreadLocal</code>使用的一些实例方法：</p>
<pre><code class="java">// 如果Key在哈希表中找不到哈希槽的时候会调用此方法
private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) {
    Entry[] tab = table;
    int len = tab.length;
    // 这里会通过nextIndex尝试遍历整个哈希表，如果找到匹配的Key则返回Entry
    // 如果哈希表中存在Key == null的情况，调用expungeStaleEntry进行清理
    while (e != null) {
        ThreadLocal&lt;?&gt; k = e.get();
        if (k == key)
            return e;
        if (k == null)
            expungeStaleEntry(i);
        else
            i = nextIndex(i, len);
        e = tab[i];
    }
    return null;
}

// 1.清空staleSlot对应哈希槽的Key和Value
// 2.对staleSlot到下一个空的哈希槽之间的所有可能冲突的哈希表部分槽进行重哈希，置空Key为null的槽
// 3.注意返回值是staleSlot之后的下一个空的哈希槽的哈希码
private int expungeStaleEntry(int staleSlot) {
    Entry[] tab = table;
    int len = tab.length;

    // expunge entry at staleSlot
    // 清空staleSlot对应哈希槽的Key和Value
    tab[staleSlot].value = null;
    tab[staleSlot] = null;
    size--;

    // Rehash until we encounter null
    // 下面的过程是对staleSlot到下一个空的哈希槽之间的所有可能冲突的哈希表部分槽进行重哈希，置空Key为null的槽
    Entry e;
    int i;
    for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
        ThreadLocal&lt;?&gt; k = e.get();
        if (k == null) {
            e.value = null;
            tab[i] = null;
            size--;
        } else {
            int h = k.threadLocalHashCode &amp; (len - 1);
            if (h != i) {
                tab[i] = null;

                // Unlike Knuth 6.4 Algorithm R, we must scan until
                // null because multiple entries could have been stale.
                while (tab[h] != null)
                    h = nextIndex(h, len);
                tab[h] = e;
            }
        }
    }
    return i;
}

// 这里个方法比较长，作用是替换哈希码为staleSlot的哈希槽中Entry的值
private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) {
    Entry[] tab = table;
    int len = tab.length;
    Entry e;

    // Back up to check for prior stale entry in current run.
    // We clean out whole runs at a time to avoid continual
    // incremental rehashing due to garbage collector freeing
    // up refs in bunches (i.e., whenever the collector runs).
    int slotToExpunge = staleSlot;
    // 这个循环主要是为了找到staleSlot之前的最前面的一个Key为null的哈希槽的哈希码
    for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))
        if (e.get() == null)
            slotToExpunge = i;

    // Find either the key or trailing null slot of run, whichever
    // occurs first
    // 遍历staleSlot之后的哈希槽，如果Key匹配则用输入值替换
    for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
        ThreadLocal&lt;?&gt; k = e.get();

        // If we find key, then we need to swap it
        // with the stale entry to maintain hash table order.
        // The newly stale slot, or any other stale slot
        // encountered above it, can then be sent to expungeStaleEntry
        // to remove or rehash all of the other entries in run.
        if (k == key) {
            e.value = value;
            tab[i] = tab[staleSlot];
            tab[staleSlot] = e;
            // Start expunge at preceding stale entry if it exists
            if (slotToExpunge == staleSlot)
                slotToExpunge = i;
            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
            return;
        }

        // If we didn&#39;t find stale entry on backward scan, the
        // first stale entry seen while scanning for key is the
        // first still present in the run.
        if (k == null &amp;&amp; slotToExpunge == staleSlot)
            slotToExpunge = i;
    }
    // Key匹配不了，则新创建一个哈希槽
    // If key not found, put new entry in stale slot
    tab[staleSlot].value = null;
    tab[staleSlot] = new Entry(key, value);

    // 这里如果当前的staleSlot和找到前置的slotToExpunge不一致会进行一次清理
    // If there are any other stale entries in run, expunge them
    if (slotToExpunge != staleSlot)
        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
}

// 对当前哈希表中所有的Key为null的Entry调用expungeStaleEntry
private void expungeStaleEntries() {
    Entry[] tab = table;
    int len = tab.length;
    for (int j = 0; j &lt; len; j++) {
        Entry e = tab[j];
        if (e != null &amp;&amp; e.get() == null)
            expungeStaleEntry(j);
    }
}

// 清理第i个哈希槽之后的n个哈希槽，如果遍历的时候发现Entry的Key为null，则n会重置为哈希表的长度，expungeStaleEntry有可能会重哈希使得哈希表长度发生变化
private boolean cleanSomeSlots(int i, int n) {
    boolean removed = false;
    Entry[] tab = table;
    int len = tab.length;
    do {
        i = nextIndex(i, len);
        Entry e = tab[i];
        if (e != null &amp;&amp; e.get() == null) {
            n = len;
            removed = true;
            i = expungeStaleEntry(i);
        }
    } while ( (n &gt;&gt;&gt;= 1) != 0);
    return removed;
}


/**
 * 这个方法主要给`ThreadLocal#get()`调用，通过当前ThreadLocal实例获取哈希表中对应的Entry
 *
 */
private Entry getEntry(ThreadLocal&lt;?&gt; key) {
    // 计算Entry的哈希值
    int i = key.threadLocalHashCode &amp; (table.length - 1);
    Entry e = table[i]; 
    if (e != null &amp;&amp; e.get() == key)
        return e;
    else  // 注意这里，如果e为null或者Key对不上，会调用getEntryAfterMiss
        return getEntryAfterMiss(key, i, e);
}

// 重哈希，必要时进行扩容
private void rehash() {
    // 清理所有空的哈希槽，并且进行重哈希
    expungeStaleEntries();

    // Use lower threshold for doubling to avoid hysteresis
    // 哈希表的哈希元素个数大于3/4阈值时候触发扩容
    if (size &gt;= threshold - threshold / 4)
        resize();
}

// 扩容，简单的扩大2倍的容量        
private void resize() {
    Entry[] oldTab = table;
    int oldLen = oldTab.length;
    int newLen = oldLen * 2;
    Entry[] newTab = new Entry[newLen];
    int count = 0;

    for (Entry e : oldTab) {
        if (e != null) {
            ThreadLocal&lt;?&gt; k = e.get();
            if (k == null) {
                e.value = null; // Help the GC
            } else {
                int h = k.threadLocalHashCode &amp; (newLen - 1);
                while (newTab[h] != null)
                     h = nextIndex(h, newLen);
                newTab[h] = e;
                count++;
            }
        }
    }

    setThreshold(newLen);
    size = count;
    table = newTab;
}

// 基于ThreadLocal作为key，对当前的哈希表设置值，此方法由`ThreadLocal#set()`调用
private void set(ThreadLocal&lt;?&gt; key, Object value) {

    // We don&#39;t use a fast path as with get() because it is at
    // least as common to use set() to create new entries as
    // it is to replace existing ones, in which case, a fast
    // path would fail more often than not.

    Entry[] tab = table;
    int len = tab.length;
    int i = key.threadLocalHashCode &amp; (len-1);
    // 变量哈希表
    for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {
        ThreadLocal&lt;?&gt; k = e.get();
        // Key匹配，直接设置值
        if (k == key) {
            e.value = value;
            return;
        }
        // 如果Entry的Key为null，则替换该Key为当前的key，并且设置值
        if (k == null) {
            replaceStaleEntry(key, value, i);
            return;
        }
    }

    tab[i] = new Entry(key, value);
    int sz = ++size;
    // 清理当前新设置元素的哈希槽下标到sz段的哈希槽，如果清理成功并且sz大于阈值则触发扩容
    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
        rehash();
}</code></pre>
<p>简单来说，<code>ThreadLocalMap</code>是<code>ThreadLocal</code>真正的数据存储容器，实际上<code>ThreadLocal</code>数据操作的复杂部分的所有逻辑都在<code>ThreadLocalMap</code>中进行，而<code>ThreadLocalMap</code>实例是<code>Thread</code>的成员变量，在<code>ThreadLocal#set()</code>方法首次调用的时候设置到当前执行的线程实例中。如果在同一个线程中使用多个<code>ThreadLocal</code>实例，实际上，每个<code>ThreadLocal</code>实例对应的是<code>ThreadLocalMap</code>的哈希表中的一个哈希槽。举个例子，在主函数主线程中使用多个<code>ThreadLocal</code>实例：</p>
<pre><code class="java">public class ThreadLocalMain {

    private static final ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;();
    private static final ThreadLocal&lt;String&gt; TL_2 = new ThreadLocal&lt;&gt;();
    private static final ThreadLocal&lt;Long&gt; TL_3 = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception {
        TL_1.set(1);
        TL_2.set(&quot;1&quot;);
        TL_3.set(1L);
        Field field = Thread.class.getDeclaredField(&quot;threadLocals&quot;);
        field.setAccessible(true);
        Object o = field.get(Thread.currentThread());
        System.out.println(o);
    }
}</code></pre>
<p>实际上，主线程的threadLocals属性中的哈希表中一般不止我们上面定义的三个<code>ThreadLocal</code>，因为加载主线程的时候还有可能在其他地方使用到<code>ThreadLocal</code>，笔者某次Debug的结果如下：</p>
<p><img src="/imag/Factory/image-20200219100739092.png" alt="main-ThreadLocal"></p>
<p>用PPT画图简化一下：</p>
<p><img src="/imag/Factory/image-20200219100834253.png" alt="image-20200219100834253"></p>
<p>上图threadLocalHashCode属性一行的表是为了标出每个Entry的哈希槽的哈希值，实际上，threadLocalHashCode是<code>ThreadLocal@XXXX</code>中的一个属性，这是很显然的，本来threadLocalHashCode就是<code>ThreadLocal</code>的一个成员变量。</p>
<p>上面只是简单粗略对<code>ThreadLocalMap</code>的源码进行了流水账的分析，下文会作一些详细的图，说明一下<code>ThreadLocal</code>和<code>ThreadLocalMap</code>中的一些核心操作的过程。</p>
<h3 id="ThreadLocal的创建"><a href="#ThreadLocal的创建" class="headerlink" title="ThreadLocal的创建"></a>ThreadLocal的创建</h3><p>从<code>ThreadLocal</code>的构造函数来看，<code>ThreadLocal</code>实例的构造并不会做任何操作，只是为了得到一个<code>ThreadLocal</code>的泛型实例，后续可以把它作为<code>ThreadLocalMap$Entry</code>的键：</p>
<pre><code class="java">// 注意threadLocalHashCode在每个新`ThreadLocal`实例的构造同时已经确定了
private final int threadLocalHashCode = nextHashCode();
private static AtomicInteger nextHashCode = new AtomicInteger();
private static final int HASH_INCREMENT = 0x61c88647;
private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}

// 通过Supplier去覆盖initialValue方法
public static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier) {
    return new SuppliedThreadLocal&lt;&gt;(supplier);
}

// 默认公有构造函数
public ThreadLocal() {

}</code></pre>
<p>注意threadLocalHashCode在每个新<code>ThreadLocal</code>实例的构造同时已经确定了，这个值也是Entry哈希表的哈希槽绑定的哈希值。</p>
<h3 id="TreadLocal的set方法"><a href="#TreadLocal的set方法" class="headerlink" title="TreadLocal的set方法"></a>TreadLocal的set方法</h3><p><code>ThreadLocal</code>中<code>set()</code>方法的源码如下:</p>
<pre><code class="java">public void set(T value) {
    //设置值前总是获取当前线程实例
    Thread t = Thread.currentThread();
    //从当前线程实例中获取threadLocals属性
    ThreadLocalMap map = getMap(t);
    if (map != null)
         //threadLocals属性不为null则覆盖key为当前的ThreadLocal实例，值为value
         map.set(this, value);
    else
    //threadLocals属性为null，则创建ThreadLocalMap，第一个项的Key为当前的ThreadLocal实例，值为value
        createMap(t, value);
}

// 这里看到获取ThreadLocalMap实例时候总是从线程实例的成员变量获取
ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}

// 创建ThreadLocalMap实例的时候，会把新实例赋值到线程实例的threadLocals成员
void createMap(Thread t, T firstValue) {
     t.threadLocals = new ThreadLocalMap(this, firstValue);
}</code></pre>
<p>上面的过程源码很简单，设置值的时候总是先获取当前线程实例并且操作它的变量threadLocals。步骤是：</p>
<ul>
<li>获取当前运行线程的实例。</li>
<li>通过线程实例获取线程实例成员threadLocals(<code>ThreadLocalMap</code>)，如果为null，则创建一个新的<code>ThreadLocalMap</code>实例赋值到threadLocals。</li>
<li>通过threadLocals设置值value，如果原来的哈希槽已经存在值，则进行覆盖。</li>
</ul>
<p><img src="/imag/Factory/image-20200219101026615.png" alt="image-20200219101026615"></p>
<p><img src="/imag/Factory/image-20200219101048389.png" alt="image-20200219101048389"></p>
<p><img src="/imag/Factory/image-20200219101109099.png" alt="image-20200219101109099"></p>
<h3 id="TreadLocal的get方法"><a href="#TreadLocal的get方法" class="headerlink" title="TreadLocal的get方法"></a>TreadLocal的get方法</h3><p><code>ThreadLocal</code>中<code>get()</code>方法的源码如下:</p>
<pre><code class="java"> public T get() {
   //获取当前线程的实例
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
    //根据当前的ThreadLocal实例获取ThreadLocalMap中的Entry，使用的是ThreadLocalMap的getEntry方法
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings(&quot;unchecked&quot;)
            T result = (T) e.value;
             return result;
            }
        }
    //线程实例中的threadLocals为null，则调用initialValue方法，并且创建ThreadLocalMap赋值到threadLocals
    return setInitialValue();
}

private T setInitialValue() {
    // 调用initialValue方法获取值
    T value = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    // ThreadLocalMap如果未初始化则进行一次创建，已初始化则直接设置值
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
    return value;
}

protected T initialValue() {
     return null;
}</code></pre>
<p><code>initialValue()</code>方法默认返回null，如果<code>ThreadLocal</code>实例没有使用过<code>set()</code>方法直接使用<code>get()</code>方法，那么<code>ThreadLocalMap</code>中的此<code>ThreadLocal</code>为Key的项会把值设置为<code>initialValue()</code>方法的返回值。如果想改变这个逻辑可以对<code>initialValue()</code>方法进行覆盖。</p>
<img src="/imag/Factory/image-20200219101207550.png" alt="image-20200219101207550" style="zoom:50%;" />

<h3 id="TreadLocal的remove方法"><a href="#TreadLocal的remove方法" class="headerlink" title="TreadLocal的remove方法"></a>TreadLocal的remove方法</h3><p><code>ThreadLocal</code>中<code>remove()</code>方法的源码如下:</p>
<pre><code class="java">public void remove() {
    //获取Thread实例中的ThreadLocalMap
    ThreadLocalMap m = getMap(Thread.currentThread());
    if (m != null)
       //根据当前ThreadLocal作为Key对ThreadLocalMap的元素进行移除
       m.remove(this);
}</code></pre>
<p><img src="/imag/Factory/image-20200219101253773.png" alt="image-20200219101253773"></p>
<h2 id="ThreadLocal-ThreadLocalMap的初始化"><a href="#ThreadLocal-ThreadLocalMap的初始化" class="headerlink" title="ThreadLocal.ThreadLocalMap的初始化"></a>ThreadLocal.ThreadLocalMap的初始化</h2><p>我们可以关注一下<code>java.lang.Thread</code>类里面的变量：</p>
<pre><code class="java">public class Thread implements Runnable {

  //传递ThreadLocal中的ThreadLocalMap变量
  ThreadLocal.ThreadLocalMap threadLocals = null;
  //传递InheritableThreadLocal中的ThreadLocalMap变量
  ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}</code></pre>
<p>也就是，<code>ThreadLocal</code>需要存放和获取的数据实际上绑定在<code>Thread</code>实例的成员变量threadLocals中，并且是<code>ThreadLocal#set()</code>方法调用的时候才进行<strong>懒加载</strong>的，可以结合上一节的内容理解一下，这里不展开。</p>
<h2 id="什么情况下ThreadLocal的使用会导致内存泄漏"><a href="#什么情况下ThreadLocal的使用会导致内存泄漏" class="headerlink" title="什么情况下ThreadLocal的使用会导致内存泄漏"></a>什么情况下ThreadLocal的使用会导致内存泄漏</h2><p>其实<code>ThreadLocal</code>本身不存放任何的数据，而<code>ThreadLocal</code>中的数据实际上是存放在线程实例中，从实际来看是线程内存泄漏，底层来看是<code>Thread</code>对象中的成员变量threadLocals持有大量的K-V结构，<strong>并且线程一直处于活跃状态导致变量threadLocals无法释放被回收</strong>。</p>
<p>threadLocals持有大量的K-V结构这一点的前提是要存在大量的<code>ThreadLocal</code>实例的定义，一般来说，一个应用不可能定义大量的<code>ThreadLocal</code>，<strong>所以一般的泄漏源是线程一直处于活跃状态导致变量threadLocals无法释放被回收</strong>。但是我们知道，·ThreadLocalMap·中的Entry结构的Key用到了弱引用(·WeakReference&lt;ThreadLocal&lt;?&gt;&gt;·)，当没有强引用来引用<code>ThreadLocal</code>实例的时候，JVM的GC会回收<code>ThreadLocalMap</code>中的这些Key，此时，<code>ThreadLocalMap</code>中会出现一些Key为null，但是Value不为null的Entry项，这些Entry项如果不主动清理，就会一直驻留在ThreadLocalMap中。也就是为什么<code>ThreadLocal</code>中<code>get()</code>、<code>set()</code>、<code>remove()</code>这些方法中都存在清理<code>ThreadLocalMap</code>实例key为null的代码块。总结下来，内存泄漏可能出现的地方是：</p>
<ul>
<li><p>1、大量地(静态)初始化<code>ThreadLocal</code>实例，初始化之后不再调用<code>get()</code>、<code>set()</code>、<code>remove()</code>方法。</p>
</li>
<li><p>2、初始化了大量的<code>ThreadLocal</code>，这些<code>ThreadLocal</code>中存放了容量大的Value，并且使用了这些<code>ThreadLocal</code>实例的线程一直处于活跃的状态。</p>
</li>
</ul>
<p><code>ThreadLocal</code>中一个设计亮点是<code>ThreadLocalMap</code>中的<code>Entry</code>结构的Key用到了弱引用。试想如果使用强引用，等于<code>ThreadLocalMap</code>中的所有数据都是与<code>Thread</code>的生命周期绑定，这样很容易出现因为大量线程持续活跃导致的内存泄漏。使用了弱引用的话，JVM触发GC回收弱引用后，<code>ThreadLocal</code>在下一次调用<code>get()</code>、<code>set()</code>、<code>remove()</code>方法就可以删除那些<code>ThreadLocalMap</code>中Key为null的值，起到了<strong>惰性删除</strong>释放内存的作用。</p>
<p>其实<code>ThreadLocal</code>在设置内部类<code>ThreadLocal.ThreadLocalMap</code>中构建的Entry哈希表已经考虑到内存泄漏的问题，所以<code>ThreadLocal.ThreadLocalMap$Entry</code>类设计为弱引用，类签名为<code>static class Entry extends WeakReference&gt;</code>。之前一篇文章介绍过，如果弱引用关联的对象如果置为null，那么该弱引用会在下一次GC时候回收弱引用关联的对象。举个例子：</p>
<pre><code class="java">public class ThreadLocalMain {

    private static ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) throws Exception {
        TL_1.set(1);
        TL_1 = null;
        System.gc();
        Thread.sleep(300);
    }
}</code></pre>
<p>这种情况下，TL_1这个<code>ThreadLocal</code>在主动GC之后，线程绑定的<code>ThreadLocal.ThreadLocalMap</code>实例中的Entry哈希表中原来的TL_1所在的哈希槽Entry的引用持有值referent(继承自<code>WeakReference</code>)会变成null，但是Entry中的value是强引用，还存放着TL_1这个<code>ThreadLocal</code>未回收之前的值。这些被”孤立”的哈希槽Entry就是前面说到的要<strong>惰性删除</strong>的哈希槽。</p>
<h2 id="ThreadLocal的最佳实践"><a href="#ThreadLocal的最佳实践" class="headerlink" title="ThreadLocal的最佳实践"></a>ThreadLocal的最佳实践</h2><p>其实<code>ThreadLocal</code>的最佳实践很简单：</p>
<ul>
<li>每次使用完<code>ThreadLocal</code>实例，都调用它的<code>remove()</code>方法，清除<code>Entry</code>中的数据。</li>
</ul>
<p>调用<code>remove()</code>方法最佳时机是<strong>线程运行结束之前的<code>finally</code>代码块</strong>中调用，这样能完全避免操作不当导致的内存泄漏，这种主动清理的方式比惰性删除有效。</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 729535228@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>ThreadLocal源码解析</p>
    <p><span class="copy-title">文章字数:</span><span class="post-count">5.1k</span></p>
    <p><span class="copy-title">本文作者:</span><a  title="Ocean Bai">Ocean Bai</a></p>
    <p><span class="copy-title">发布时间:</span>2020-02-19, 09:41:31</p>
    <p><span class="copy-title">最后更新:</span>2020-03-03, 11:58:15</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="ThreadLocal源码解析">http://yoursite.com/2020/02/19/java/JDK/ThreadLocal%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>








    </div>
    <div class="copyright">
        <p class="footer-entry">©2019-2020 Ocean</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#面试','#Redis','#jvm','#类加载器','#垃圾','#AOP','#算法','#反射','#缓存','#IOC','#SpringBoot常用注解','#SPI','#动态代理','#mysql','#日志系统','#索引','#设计模式','#工厂模式','#事务','#三次握手','#四次挥手','#设计原则','#练习','#总结面试','#java','#多态','#指令','#arrayList','#Volatile','#ThreadLocal','#hashmap','#内存模型','#线程池','#synchronized',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
        /* 渲染*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("//cdn.jsdelivr.net/npm/mermaid@8.4.2/dist/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&#34;theme&#34;:&#34;default&#34;,&#34;startOnLoad&#34;:true,&#34;flowchart&#34;:{&#34;useMaxWidth&#34;:false,&#34;htmlLabels&#34;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
